<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø³ÙˆØ¨Ø± Ø¨Ø·Ù„ Ø§Ù„Ù…Ø¹Ø±ÙØ© - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Press+Start+2P&display=swap');
        
        body {
            margin: 0; background: #202020; color: white;
            font-family: 'Cairo', sans-serif;
            height: 100vh; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            overflow: hidden; touch-action: none; /* Ù…Ù†Ø¹ Ø§Ù„Ø³Ø­Ø¨ ÙÙŠ Ø§Ù„Ø¬ÙˆØ§Ù„ */
        }

        #game-wrapper {
            position: relative;
            width: 100%; max-width: 800px;
            aspect-ratio: 16/10;
            background: #5C94FC;
            border: 4px solid #fff;
            box-shadow: 0 0 40px rgba(0,0,0,0.8);
            overflow: hidden;
        }

        canvas { display: block; width: 100%; height: 100%; image-rendering: pixelated; }

        /* Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© */
        #hud {
            position: absolute; top: 10px; left: 10px; right: 10px;
            display: flex; justify-content: space-between;
            font-family: 'Press Start 2P', cursive;
            font-size: 12px; text-shadow: 2px 2px #000;
            pointer-events: none; direction: ltr;
        }

        /* Ø´Ø§Ø´Ø§Øª Ø§Ù„ØªÙˆÙ‚Ù ÙˆØ§Ù„Ø¨Ø¯Ø§ÙŠØ© */
        .overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.85);
            display: none; flex-direction: column; 
            align-items: center; justify-content: center; z-index: 100;
        }
        .overlay.active { display: flex; }
        
        h1 { color: #ffce00; text-shadow: 4px 4px #b22222; margin-bottom: 20px; font-size: 24px; text-align: center; }
        .btn-start {
            background: #e70000; color: white; border: 4px solid white;
            padding: 15px 40px; font-size: 18px; cursor: pointer;
            font-family: 'Press Start 2P', cursive;
        }
        .btn-start:active { transform: scale(0.95); }

        /* Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø¦Ù„Ø© */
        .quiz-box {
            background: #5C94FC; border: 4px solid white; padding: 20px;
            border-radius: 10px; width: 80%; max-width: 400px;
            text-align: center; box-shadow: 10px 10px 0 #000;
        }
        .visual-math {
            display: flex; justify-content: center; gap: 5px; flex-wrap: wrap;
            margin: 15px 0; min-height: 40px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px;
        }
        .ball {
            width: 20px; height: 20px; background: radial-gradient(circle at 30% 30%, #ff4d4d, #990000);
            border-radius: 50%; border: 2px solid white;
        }
        .ball.crossed { opacity: 0.5; position: relative; }
        .ball.crossed::after { content:'âœ–'; position: absolute; left:2px; top:-2px; font-weight:bold; color:black; }
        
        .math-q { font-size: 28px; direction: ltr; margin-bottom: 20px; text-shadow: 2px 2px #000; font-family: 'Press Start 2P'; }
        
        .answers { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .ans-btn {
            background: #ffce00; border: 2px solid black; padding: 15px;
            font-size: 20px; font-weight: bold; cursor: pointer;
            font-family: 'Cairo';
        }

        /* ØªØ­ÙƒÙ… Ø§Ù„Ø¬ÙˆØ§Ù„ */
        #mobile-controls {
            position: absolute; bottom: 10px; left: 10px; right: 10px;
            display: none; justify-content: space-between; pointer-events: none;
        }
        /* ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ù„Ù…Ø³ÙŠØ© */
        @media (hover: none) and (pointer: coarse) { #mobile-controls { display: flex; } }
        
        .ctrl-group { display: flex; gap: 15px; pointer-events: auto; }
        .t-btn {
            width: 70px; height: 70px; background: rgba(255,255,255,0.2);
            border: 3px solid rgba(255,255,255,0.6); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 30px; color: white; user-select: none;
            touch-action: none; /* Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ */
        }
        .t-btn:active { background: rgba(255,255,255,0.5); transform: scale(0.9); }
        .btn-a { background: rgba(255, 0, 0, 0.3); border-color: rgba(255, 0, 0, 0.6); }

        /* Ø§Ù„ÙÙˆØªØ± ÙˆØ§Ù„Ø­Ù‚ÙˆÙ‚ */
        .footer {
            margin-top: 10px; text-align: center; color: #888; font-size: 12px;
            display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;
        }
        .footer a { color: #ccc; text-decoration: none; display: flex; align-items: center; gap: 5px; }
        .footer img { width: 16px; height: 16px; }
    </style>
</head>
<body>

    <div id="game-wrapper">
        <canvas id="canvas"></canvas>
        
        <div id="hud">
            <div>MARIO<br><span id="score">000000</span></div>
            <div>COINS<br><span id="coins">x00</span></div>
            <div>WORLD<br><span>1-1</span></div>
            <div>TIME<br><span id="time">400</span></div>
        </div>

        <div id="start-screen" class="overlay active">
            <h1>Ø³ÙˆØ¨Ø± Ø¨Ø·Ù„ Ø§Ù„Ù…Ø¹Ø±ÙØ©</h1>
            <p style="margin-bottom:20px; font-size:14px; color:#ddd">Ø§Ø¬Ù…Ø¹ Ø§Ù„Ø¹Ù…Ù„Ø§Øª ÙˆØ§Ù‚Ø¶Ù Ø¹Ù„Ù‰ Ø§Ù„ÙØ·Ø± Ø§Ù„Ø´Ø±ÙŠØ±!</p>
            <button class="btn-start" onclick="startGame()">Ø§Ø¶ØºØ· Ù„Ù„Ø¨Ø¯Ø¡</button>
        </div>

        <div id="quiz-screen" class="overlay">
            <div class="quiz-box">
                <h2 style="margin:0 0 10px 0; color:#ffce00; text-shadow:2px 2px #000;">Ø£Ù†Ù‚Ø° Ø§Ù„Ø¨Ø·Ù„!</h2>
                <div style="width:100%; height:10px; background:#333; margin-bottom:10px;">
                    <div id="timer-bar" style="width:100%; height:100%; background:#0f0;"></div>
                </div>
                <div class="visual-math" id="visual-math"></div>
                <div class="math-q" id="math-q">5 + 3 = ?</div>
                <div class="answers" id="answers"></div>
            </div>
        </div>

        <div id="mobile-controls">
            <div class="ctrl-group">
                <div class="t-btn" id="btn-left">â—€</div>
                <div class="t-btn" id="btn-right">â–¶</div>
            </div>
            <div class="ctrl-group">
                <div class="t-btn btn-a" id="btn-jump">A</div>
            </div>
        </div>
    </div>

    <div class="footer">
        <span>Â© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù€ <b>Ø³Ù„Ù…Ø§Ù† Ø§Ù„Ø¬Ù†ÙŠØ¯ÙŠ</b></span>
        <a href="https://wa.me/966566996166" target="_blank">ğŸ“± ÙˆØ§ØªØ³Ø§Ø¨</a>
        <a href="https://snapchat.com/t/2tVDWcXq" target="_blank">ğŸ‘» Ø³Ù†Ø§Ø¨ Ø´Ø§Øª</a>
    </div>

<script>
/**
 * Ù…Ø­Ø±Ùƒ Ø§Ù„Ù„Ø¹Ø¨Ø© - Ù…Ø§Ø±ÙŠÙˆ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ
 * ØªØµÙ…ÙŠÙ… ÙˆØ¨Ø±Ù…Ø¬Ø©: Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø·Ù„Ø¨ Ø³Ù„Ù…Ø§Ù† Ø§Ù„Ø¬Ù†ÙŠØ¯ÙŠ
 */

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

// Ø¯Ù‚Ø© ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠØ©
const W = 320;
const H = 240;

function resize() {
    // Ø¬Ø¹Ù„ Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ ÙŠÙ…Ù„Ø£ Ø§Ù„Ø¥Ø·Ø§Ø± Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙƒØ³Ù„Ø§Øª
    const wrapper = document.getElementById('game-wrapper');
    canvas.width = W;
    canvas.height = H;
    // CSS Scale handled by flex layout
}
window.addEventListener('resize', resize);
resize();

// === 1. Ø§Ù„Ø±Ø³ÙˆÙ…Ø§Øª (Assets) ===
// Ø±Ø³Ù…Øª Ù„Ùƒ Ø³Ø¨Ø±Ø§ÙŠØªØ§Øª Ù…Ø§Ø±ÙŠÙˆ ÙŠØ¯ÙˆÙŠØ§Ù‹ ÙˆØ­ÙˆÙ„ØªÙ‡Ø§ Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø´Ø§Ù† Ø§Ù„Ø´ÙƒÙ„ ÙŠÙƒÙˆÙ† Ù…Ù…ØªØ§Ø²
const SPRITES = {
    mario: {
        idle: drawPixelsToCanvas(["000RRRRR000","00RRRRRRRRR","00BBBPBBP00","0BWBWBPPP00","0BWBWBPPP00","0BBPPPBP000","000PPPPP000","00RRBRR0000","0RRRBRRR000","RRRRBBBBRRR","ZZRBWWWBZZZ","ZZZWWWWWZZZ","ZZWWWWWWZZZ","00BBB0BBB00","0BBB00BBB00","BBB000BBB00"]),
        run: drawPixelsToCanvas(["000RRRRR000","00RRRRRRRRR","00BBBPBBP00","0BWBWBPPP00","0BWBWBPPP00","0BBPPPBP000","000PPPPP000","00RRBRR0000","0RRRBRRR000","RRRRBBBBRRR","ZZRBWWWBZZZ","ZZZWWWWWZZZ","ZZWWWWWWZZZ","00BBBBBB000","0BBBB000000","BBB00000000"]),
        jump: drawPixelsToCanvas(["000RRRRR000","00RRRRRRRRR","00BBBPBBP00","0BWBWBPPP00","0BWBWBPPP00","0BBPPPBP000","000PPPPP000","0RRRBRRR000","RRRRBBBBRRR","ZZRBWWWBZZZ","ZZZWWWWWZZZ","0BWWWWWWB00","0BBBBBBBB00","00000000000","00000000000","00000000000"])
    },
    goomba: drawPixelsToCanvas(["00000000000","000BBBB0000","00BBBBBB000","0BBBBBBBB00","0BBBBBBBB00","0BB0000BB00","0BB0WW0BB00","0BB0000BB00","0BBBBBBBB00","00BBBBBB000","00000000000","00ZZZ0ZZZ00","0ZZZZ0ZZZZ0","ZZZZZ0ZZZZZ","00000000000","00000000000"], {'B':'#A0522D', 'W':'#fff', 'Z':'#000'}),
    brick: drawPixelsToCanvas(["BBBBBBBBBBBBBBBB","BZZZZBZZZZZZZZZB","BZZZZBZZZZZZZZZB","BBBBBBBBBBBBBBBB","BZZZZZZZZBZBZZZB","BZZZZZZZZBZBZZZB","BBBBBBBBBBBBBBBB","BZZZBZZZZZZZZZZB","BZZZBZZZZZZZZZZB","BBBBBBBBBBBBBBBB"], {'B':'#B22222', 'Z':'#CD5C5C'}),
    qblock: drawPixelsToCanvas(["YYYYYYYYYYYYYYYY","YZZZZZZZZZZZZZZO","YZOOOOOOOOOOOOZO","YZOYZZZZZZZZOYZO","YZOYZYYYYZZZOYZO","YZOYZYYYYZZZOYZO","YZOYZZZZZYYZOYZO","YZOYZZZZYYYZOYZO","YZOOOOOZYYZOOOZO","YZZZZZZZYYZZZZZO","YZZZZZZZYYZZZZZO","YZZZZZZZZZZZZZZO","YZZZZZZZYYZZZZZO","YZZZZZZZYYZZZZZO","YZZZZZZZZZZZZZZO","YOOOOOOOOOOOOOOO"], {'Y':'#FFD700', 'Z':'#FF8C00', 'O':'#000'}),
    ground: drawPixelsToCanvas(["GGGGGGGGGGGGGGGG","GZZZZZZZZZZZZZZG","GZZZZZZZZZZZZZZG","GZZZZZZZZZZZZZZG","GZZZZZZZZZZZZZZG","GZZZOOOOOOOOZZZG","GZZOZZZZZZZZOZZG","GZZOZZZZZZZZOZZG","GZZOZZZZZZZZOZZG","GZZZOOOOOOOOZZZG","GZZZZZZZZZZZZZZG","GZZZZZZZZZZZZZZG","GZZZZZZZZZZZZZZG","GZZZZZZZZZZZZZZG","GGGGGGGGGGGGGGGG"], {'G':'#8B4513', 'Z':'#CD853F', 'O':'#A0522D'}),
    pipe: drawPixelsToCanvas(["00000000","00GGGG00","0GLLLLG0","0GLLLLG0","0GLLLLG0","00GGGG00","00GLLG00","00GLLG00"], {'G':'#006400', 'L':'#32CD32'}) // Simplified
};

function drawPixelsToCanvas(rows, palette) {
    // Default Palette (Mario)
    if(!palette) palette = {'R':'#f00', 'B':'#00f', 'P':'#fc9', 'W':'#fff', 'Z':'#8B4513', '0':null};
    
    const c = document.createElement('canvas');
    c.width = rows[0].length;
    c.height = rows.length;
    const x = c.getContext('2d');
    
    for(let r=0; r<rows.length; r++) {
        for(let col=0; col<rows[r].length; col++) {
            const color = palette[rows[r][col]];
            if(color) {
                x.fillStyle = color;
                x.fillRect(col, r, 1, 1);
            }
        }
    }
    return c;
}

// === 2. Ø§Ù„Ù…Ø­Ø±Ùƒ ÙˆØ§Ù„ÙÙŠØ²ÙŠØ§Ø¡ ===
let game = {
    state: 'MENU',
    score: 0, coins: 0, time: 400,
    cameraX: 0,
    width: 200 * 16, // Ø·ÙˆÙ„ Ø§Ù„Ù…Ø±Ø­Ù„Ø©
    entities: [],
    tiles: [],
    safeSpot: {x:50, y:100}
};

let player = {
    x: 50, y: 100, w: 12, h: 16,
    vx: 0, vy: 0,
    grounded: false, facing: 1, dead: false,
    frame: 0
};

let inputs = { left:false, right:false, jump:false };

// Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø·ÙˆÙŠÙ„Ø©
function initLevel() {
    game.tiles = []; game.entities = [];
    const mapStr = 
    "                                                                                                                                                                                                " +
    "                                                                                                                                                                                                " +
    "                                                                                                                                                                                                " +
    "      ?   ? B?B ?                                                                     B?B?B                                                                                                     " +
    "                    ?   B?B                              PP                           B B B                                                                                                     " +
    "                                  PP                     PP                                             B?B                                                                   F                 " +
    "                  G               PP         G           PP       G         G         B?B?B     G      BBBBB                                                                  F                 " +
    "MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM  MMMMMMMMMMMMMMMMMMMMMMMM  MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM  MMMMMMMMMMMMMMMMMMMM  MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM";

    for(let r=0; r<8; r++) { // 8 rows high (scaled)
        for(let c=0; c<mapStr.length; c++) {
            const char = mapStr[r * 200 + c] || ' '; // simple parsing logic
            const idx = r * 208 + c; // approx
            // Better parsing:
        }
    }
    
    // Manual Level Construction for stability
    const groundY = H - 32;
    // Floor
    for(let i=0; i<250; i++) {
        if(i<30 || (i>35 && i<60) || (i>65 && i<120) || (i>125)) {
            game.tiles.push({x:i*16, y:groundY, type:'ground'});
            game.tiles.push({x:i*16, y:groundY+16, type:'ground'});
        }
    }
    
    // Objects
    const addRect = (x,y,type) => game.tiles.push({x:x*16, y:groundY-(y*16), type:type});
    const addEnemy = (x) => game.entities.push({x:x*16, y:groundY-16, w:16, h:16, type:'goomba', vx:-0.5, vy:0, dead:false});
    
    addRect(10, 4, 'qblock');
    addRect(14, 4, 'brick'); addRect(15, 4, 'qblock'); addRect(16, 4, 'brick'); addRect(17, 4, 'qblock');
    addRect(15, 8, 'qblock');
    
    // Pipes
    addRect(25, 2, 'pipe'); addRect(25, 3, 'pipe');
    addRect(35, 2, 'pipe'); addRect(35, 3, 'pipe'); addRect(35, 4, 'pipe');
    
    // Stairs
    for(let i=0; i<5; i++) {
        for(let j=0; j<=i; j++) addRect(80+i, 2+j, 'brick');
    }
    
    addEnemy(20); addEnemy(40); addEnemy(55); addEnemy(90); addEnemy(110);
    
    // Flag
    game.tiles.push({x:200*16, y:groundY-16, type:'flag'});
}

function startGame() {
    document.getElementById('start-screen').classList.remove('active');
    initLevel();
    player.x = 50; player.y = 100; player.vx=0; player.vy=0;
    game.cameraX = 0; game.score = 0; game.coins = 0;
    game.state = 'PLAYING';
    loop();
}

function update() {
    if(game.state !== 'PLAYING') return;

    // Ø­Ø±ÙƒØ© Ø§Ù„Ù„Ø§Ø¹Ø¨
    if(inputs.right) { player.vx += 0.5; player.facing = 1; }
    else if(inputs.left) { player.vx -= 0.5; player.facing = -1; }
    else { player.vx *= 0.8; }
    
    player.vx = Math.max(Math.min(player.vx, 3), -3);
    
    if(inputs.jump && player.grounded) {
        player.vy = -6.5;
        player.grounded = false;
        player.frame = 1; // Jump frame
    }
    
    player.vy += 0.3; // Gravity
    
    player.x += player.vx;
    checkColX();
    player.y += player.vy;
    player.grounded = false;
    checkColY();
    
    // Animation
    if(player.grounded) {
        if(Math.abs(player.vx) > 0.2) player.frame += 0.15;
        else player.frame = 0;
    }
    
    // Death
    if(player.y > H + 50) die();
    
    // Entities
    game.entities.forEach(e => {
        if(e.dead) return;
        if(Math.abs(player.x - e.x) < W) {
            e.vy += 0.3; e.x += e.vx; e.y += e.vy;
            // Floor collision for enemy (simplified)
            let onG = false;
            game.tiles.forEach(t => {
                if(rectIntersect(e, {x:t.x, y:t.y, w:16, h:16})) {
                    if(e.vy>0) { e.y = t.y-e.h; e.vy=0; onG=true; }
                }
            });
            // Player collision
            if(rectIntersect(player, e)) {
                if(player.vy > 0 && player.y < e.y) {
                    e.dead = true; player.vy = -4;
                    game.score += 100;
                } else {
                    die();
                }
            }
        }
    });

    // Camera
    let target = player.x - W*0.4;
    target = Math.max(0, target);
    game.cameraX += (target - game.cameraX) * 0.1;
    
    // Update UI
    document.getElementById('score').innerText = game.score.toString().padStart(6,'0');
    document.getElementById('coins').innerText = 'x' + game.coins.toString().padStart(2,'0');
    
    // Check Win
    if(player.x > 198*16) {
        alert("Ù…Ø¨Ø±ÙˆÙƒ! Ø£Ù†Ù‡ÙŠØª Ø§Ù„Ù…Ø±Ø­Ù„Ø©!");
        game.state = 'MENU';
        document.getElementById('start-screen').classList.add('active');
    }
    
    // Safe spot update
    if(player.grounded) game.safeSpot = {x:player.x, y:player.y-10};
}

function checkColX() {
    game.tiles.forEach(t => {
        if(t.type === 'flag') return;
        if(rectIntersect(player, {x:t.x, y:t.y, w:16, h:16})) {
            if(player.vx > 0) player.x = t.x - player.w;
            else if(player.vx < 0) player.x = t.x + 16;
            player.vx = 0;
        }
    });
}

function checkColY() {
    game.tiles.forEach(t => {
        if(t.type === 'flag') return;
        if(rectIntersect(player, {x:t.x, y:t.y, w:16, h:16})) {
            if(player.vy > 0) {
                player.y = t.y - player.h;
                player.vy = 0;
                player.grounded = true;
            } else if(player.vy < 0) {
                player.y = t.y + 16;
                player.vy = 0;
                if(t.type === 'qblock') {
                    t.type = 'brick';
                    game.coins++; game.score+=50;
                }
            }
        }
    });
}

function rectIntersect(r1, r2) {
    return !(r2.x > r1.x + r1.w || 
             r2.x + r2.w < r1.x || 
             r2.y > r1.y + r1.h ||
             r2.y + r2.h < r1.y);
}

function draw() {
    // Clear
    ctx.fillStyle = '#5C94FC';
    ctx.fillRect(0,0,W,H);
    
    ctx.save();
    ctx.translate(-Math.floor(game.cameraX), 0);
    
    // Draw Tiles
    game.tiles.forEach(t => {
        let img = null;
        if(t.type==='ground') img = SPRITES.ground;
        else if(t.type==='brick') img = SPRITES.brick;
        else if(t.type==='qblock') img = SPRITES.qblock;
        else if(t.type==='pipe') { 
            ctx.fillStyle='#00aa00'; ctx.fillRect(t.x,t.y,32,32); 
            ctx.strokeStyle='#004400'; ctx.strokeRect(t.x,t.y,32,32);
            return;
        }
        else if(t.type==='flag') {
             ctx.fillStyle='#fff'; ctx.fillRect(t.x, t.y-100, 4, 116);
             ctx.fillStyle='red'; ctx.fillRect(t.x+4, t.y-100, 20, 16);
             return;
        }
        
        if(img) ctx.drawImage(img, t.x, t.y);
    });
    
    // Draw Entities
    game.entities.forEach(e => {
        if(!e.dead) ctx.drawImage(SPRITES.goomba, e.x, e.y);
    });
    
    // Draw Player
    let pImg = SPRITES.mario.idle;
    if(!player.grounded) pImg = SPRITES.mario.jump;
    else if(Math.abs(player.vx) > 0.1) {
        pImg = (Math.floor(player.frame)%2===0) ? SPRITES.mario.run : SPRITES.mario.idle;
    }
    
    ctx.save();
    if(player.facing === -1) {
        ctx.translate(Math.floor(player.x)+16, Math.floor(player.y));
        ctx.scale(-1, 1);
        ctx.drawImage(pImg, 4, 0); // adjust x
    } else {
        ctx.drawImage(pImg, Math.floor(player.x), Math.floor(player.y));
    }
    ctx.restore();
    
    ctx.restore();
}

function loop() {
    if(game.state === 'PLAYING') {
        update();
        draw();
        requestAnimationFrame(loop);
    }
}

// === 3. Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ===
let quizTimerInt;
function die() {
    game.state = 'QUIZ';
    document.getElementById('quiz-screen').classList.add('active');
    
    // Ø£Ø±Ù‚Ø§Ù… Ø¹Ø±Ø¨ÙŠØ©
    const toArabic = n => (''+n).replace(/\d/g, d=>'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©'[d]);
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³Ø¤Ø§Ù„
    const isSum = Math.random() > 0.5;
    let a = Math.floor(Math.random()*11);
    let b = Math.floor(Math.random()*11);
    
    if(!isSum && b > a) [a,b] = [b,a];
    
    const ans = isSum ? a+b : a-b;
    const sign = isSum ? '+' : 'âˆ’';
    
    document.getElementById('math-q').innerText = `${toArabic(a)} ${sign} ${toArabic(b)} = ØŸ`;
    
    // Ø§Ù„ØªÙ…Ø«ÙŠÙ„ Ø§Ù„Ø¨ØµØ±ÙŠ
    const vis = document.getElementById('visual-math');
    vis.innerHTML = '';
    
    // ÙƒØ±Ø§Øª Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆÙ„
    for(let i=0; i<a; i++) {
        let ball = document.createElement('div');
        ball.className = 'ball';
        // Ø¥Ø°Ø§ Ø·Ø±Ø­ØŒ Ù†Ø´Ø·Ø¨
        if(!isSum && i >= (a-b)) ball.classList.add('crossed');
        vis.appendChild(ball);
    }
    
    if(isSum && b > 0) {
        let plus = document.createElement('div'); plus.innerText = '+'; plus.style.alignSelf='center';
        vis.appendChild(plus);
        for(let i=0; i<b; i++) {
            let ball = document.createElement('div'); ball.className='ball';
            vis.appendChild(ball);
        }
    }
    
    // Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
    const ansDiv = document.getElementById('answers');
    ansDiv.innerHTML = '';
    let opts = new Set([ans]);
    while(opts.size<4) opts.add(Math.max(0, ans + Math.floor(Math.random()*5)-2));
    
    Array.from(opts).sort(()=>Math.random()-0.5).forEach(o => {
        let btn = document.createElement('button');
        btn.className = 'ans-btn';
        btn.innerText = toArabic(o);
        btn.onclick = () => {
             if(o === ans) {
                 clearInterval(quizTimerInt);
                 document.getElementById('quiz-screen').classList.remove('active');
                 player.x = game.safeSpot.x;
                 player.y = game.safeSpot.y - 20;
                 player.vx = 0; player.vy = 0;
                 game.state = 'PLAYING';
                 loop();
             } else {
                 btn.style.background = '#555'; // Ø®Ø·Ø£
             }
        }
        ansDiv.appendChild(btn);
    });
    
    // Ø§Ù„Ù…Ø¤Ù‚Øª
    let timeLeft = 30;
    const bar = document.getElementById('timer-bar');
    if(quizTimerInt) clearInterval(quizTimerInt);
    quizTimerInt = setInterval(() => {
        timeLeft--;
        bar.style.width = (timeLeft/30)*100 + '%';
        if(timeLeft<=0) {
            clearInterval(quizTimerInt);
            document.getElementById('quiz-screen').classList.remove('active');
            document.getElementById('start-screen').classList.add('active');
            game.state='MENU';
        }
    }, 1000);
}

// === 4. Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª (ØªÙ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ù„Ù„Ø¬ÙˆØ§Ù„) ===
// Keyboard
window.addEventListener('keydown', e => {
    if(e.code==='ArrowRight') inputs.right=true;
    if(e.code==='ArrowLeft') inputs.left=true;
    if(e.code==='Space'||e.code==='ArrowUp') inputs.jump=true;
});
window.addEventListener('keyup', e => {
    if(e.code==='ArrowRight') inputs.right=false;
    if(e.code==='ArrowLeft') inputs.left=false;
    if(e.code==='Space'||e.code==='ArrowUp') inputs.jump=false;
});

// Touch (Fixed)
function bindTouch(id, key) {
    const el = document.getElementById(id);
    el.addEventListener('touchstart', (e) => { e.preventDefault(); inputs[key]=true; });
    el.addEventListener('touchend', (e) => { e.preventDefault(); inputs[key]=false; });
}
bindTouch('btn-left', 'left');
bindTouch('btn-right', 'right');
bindTouch('btn-jump', 'jump');

</script>
</body>
</html>
