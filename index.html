<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø³ÙˆØ¨Ø± Ø¨Ø·Ù„ Ø§Ù„Ù…Ø¹Ø±ÙØ© - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„ÙƒØ§Ù…Ù„</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@700&family=Press+Start+2P&display=swap');
        
        body {
            margin: 0; background: #111; color: white;
            font-family: 'Cairo', sans-serif;
            height: 100vh; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            overflow: hidden; touch-action: none; user-select: none;
            -webkit-user-select: none;
        }

        #game-frame {
            position: relative;
            width: 100%; max-width: 800px;
            aspect-ratio: 16/10;
            background: #5C94FC;
            border: 4px solid #fff;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            overflow: hidden;
        }

        canvas { display: block; width: 100%; height: 100%; image-rendering: pixelated; }

        /* Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù„ÙˆÙŠØ© */
        #hud {
            position: absolute; top: 10px; left: 10px; right: 10px;
            display: flex; justify-content: space-between;
            font-family: 'Press Start 2P', cursive;
            font-size: 12px; text-shadow: 2px 2px #000;
            pointer-events: none; z-index: 20; direction: ltr;
        }

        /* Ø§Ù„Ø´Ø§Ø´Ø§Øª */
        .overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.92);
            display: none; flex-direction: column; 
            align-items: center; justify-content: center; z-index: 100;
            text-align: center;
        }
        .overlay.active { display: flex; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from {opacity:0} to {opacity:1} }
        
        h1 { color: #ffce00; text-shadow: 4px 4px #b22222; font-size: 28px; margin: 0 0 20px; font-family: 'Press Start 2P'; line-height: 1.5; }
        p { color: #ccc; font-size: 14px; margin-bottom: 30px; max-width: 80%; }
        
        .btn {
            background: #E52521; color: white; border: 4px solid white;
            padding: 15px 40px; font-size: 18px; cursor: pointer;
            font-family: 'Cairo'; font-weight: bold;
            box-shadow: 0 6px 0 #900; transition: transform 0.1s;
        }
        .btn:active { transform: translateY(4px); box-shadow: 0 2px 0 #900; }

        /* Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø¦Ù„Ø© */
        .quiz-panel {
            background: #5C94FC; border: 4px solid white; padding: 20px;
            border-radius: 12px; width: 90%; max-width: 450px;
            box-shadow: 15px 15px 0 rgba(0,0,0,0.5); position: relative;
        }
        .timer-wrap { width: 100%; height: 12px; background: #000; margin-bottom: 15px; border-radius: 6px; overflow: hidden; }
        #timer-bar { width: 100%; height: 100%; background: #00E700; transition: width 0.2s linear; }
        
        .visual-area {
            display: flex; justify-content: center; gap: 8px; flex-wrap: wrap;
            margin: 15px 0; min-height: 50px; background: rgba(0,0,0,0.2); 
            padding: 15px; border-radius: 8px; align-items: center;
        }
        .dot {
            width: 28px; height: 28px; background: radial-gradient(circle at 30% 30%, #ff5555, #aa0000);
            border-radius: 50%; border: 3px solid white; box-shadow: 2px 2px 4px rgba(0,0,0,0.4);
        }
        .dot.dead { background: #555; opacity: 0.5; position: relative; }
        .dot.dead::after { content:'âœ–'; position: absolute; left: 50%; top: 50%; transform: translate(-50%,-50%); font-size: 20px; font-weight: bold; }
        .op-sign { font-size: 30px; font-weight: bold; margin: 0 10px; }
        
        .q-text { font-size: 32px; direction: ltr; margin: 15px 0; text-shadow: 2px 2px #000; font-family: 'Press Start 2P'; }
        
        .ans-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .ans-btn {
            background: #ffce00; border: 3px solid #000; padding: 15px;
            font-size: 24px; font-weight: bold; cursor: pointer; color: #000;
            border-radius: 8px; font-family: 'Cairo';
        }
        .ans-btn:active { background: #e6b800; transform: scale(0.98); }

        /* ØªØ­ÙƒÙ… Ø§Ù„Ø¬ÙˆØ§Ù„ */
        #touch-controls {
            position: absolute; bottom: 20px; left: 20px; right: 20px;
            display: none; justify-content: space-between; z-index: 50;
            pointer-events: none; /* ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„Ø¶ØºØ· Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ */
        }
        @media (hover: none) and (pointer: coarse) { #touch-controls { display: flex; } }
        
        .dpad { display: flex; gap: 20px; pointer-events: auto; }
        .action { pointer-events: auto; }
        
        .t-btn {
            width: 80px; height: 80px; background: rgba(255,255,255,0.15);
            border: 4px solid rgba(255,255,255,0.6); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 35px; color: white; backdrop-filter: blur(5px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); transition: background 0.1s;
        }
        .t-btn:active { background: rgba(255,255,255,0.4); transform: scale(0.95); }
        .btn-jump { background: rgba(255, 60, 60, 0.2); border-color: rgba(255, 80, 80, 0.7); font-weight: 900; font-size: 24px; }

        .footer {
            margin-top: 15px; text-align: center; color: #666; font-size: 11px;
            display: flex; gap: 20px; flex-wrap: wrap; justify-content: center;
        }
        .footer a { color: #888; text-decoration: none; display: flex; align-items: center; gap: 6px; padding: 5px 10px; border: 1px solid #333; border-radius: 20px; transition: 0.2s; }
        .footer a:hover { border-color: #666; color: #fff; }
    </style>
</head>
<body>

<div id="game-frame">
    <canvas id="canvas"></canvas>
    
    <div id="hud">
        <div>MARIO<br><span id="score">000000</span></div>
        <div>COINS<br><span id="coins">x00</span></div>
        <div>WORLD<br><span id="world">1-1</span></div>
        <div>TIME<br><span id="time">000</span></div>
    </div>

    <div id="start-screen" class="overlay active">
        <h1>Ø³ÙˆØ¨Ø± Ø¨Ø·Ù„ Ø§Ù„Ù…Ø¹Ø±ÙØ©</h1>
        <p>Ø§Ø¬Ù…Ø¹ Ø§Ù„Ø¹Ù…Ù„Ø§ØªØŒ ÙˆØ§Ù‡Ø²Ù… Ø§Ù„ÙØ·Ø± Ø§Ù„Ø´Ø±ÙŠØ±ØŒ ÙˆØ­Ù„ Ø§Ù„Ù…Ø³Ø§Ø¦Ù„ Ù„ØªÙ†Ø¬Ùˆ!</p>
        <button class="btn" onclick="Game.init()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…ØºØ§Ù…Ø±Ø© â–¶</button>
    </div>

    <div id="quiz-screen" class="overlay">
        <div class="quiz-panel">
            <h2 style="margin:0 0 15px 0; color:#ffce00; text-shadow:2px 2px #000;">Ø£Ù†Ù‚Ø° Ø§Ù„Ø¨Ø·Ù„! ğŸ„</h2>
            <div class="timer-wrap"><div id="timer-bar"></div></div>
            <div class="visual-area" id="visual-math"></div>
            <div class="q-text" id="math-q"></div>
            <div class="ans-grid" id="answers"></div>
        </div>
    </div>

    <div id="touch-controls">
        <div class="dpad">
            <div class="t-btn" id="btn-left">â—€</div>
            <div class="t-btn" id="btn-right">â–¶</div>
        </div>
        <div class="action">
            <div class="t-btn btn-jump" id="btn-jump">A</div>
        </div>
    </div>
</div>

<div class="footer">
    <span>Â© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù€ <b>Ø³Ù„Ù…Ø§Ù† Ø§Ù„Ø¬Ù†ÙŠØ¯ÙŠ</b></span>
    <a href="https://wa.me/966566996166" target="_blank">ğŸ“± ÙˆØ§ØªØ³Ø§Ø¨</a>
    <a href="https://snapchat.com/t/2tVDWcXq" target="_blank">ğŸ‘» Ø³Ù†Ø§Ø¨ Ø´Ø§Øª</a>
</div>

<script>
/**
 * Super Knowledge Hero - V6 Ultimate
 * Developed for Salman Aljunaidi
 */

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
// Ø¯Ù‚Ø© Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙŠÙˆ Ø§Ù„Ø£ØµÙ„ÙŠØ© (NES Resolution)
const WIDTH = 256;
const HEIGHT = 240;
canvas.width = WIDTH;
canvas.height = HEIGHT;

// === 1. Audio System (Ø£ØµÙˆØ§Øª 8-bit) ===
const AudioSys = {
    ctx: null,
    init: function() {
        if (!this.ctx) {
            this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if(this.ctx.state === 'suspended') this.ctx.resume();
    },
    play: function(type) {
        if (!this.ctx) return;
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        osc.connect(gain);
        gain.connect(this.ctx.destination);
        const t = this.ctx.currentTime;

        if (type === 'jump') {
            osc.type = 'square';
            osc.frequency.setValueAtTime(150, t);
            osc.frequency.linearRampToValueAtTime(300, t + 0.1);
            gain.gain.setValueAtTime(0.1, t);
            gain.gain.linearRampToValueAtTime(0, t + 0.1);
            osc.start(t); osc.stop(t + 0.1);
        } else if (type === 'coin') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(987, t); // B5
            osc.frequency.setValueAtTime(1318, t + 0.08); // E6
            gain.gain.setValueAtTime(0.1, t);
            gain.gain.linearRampToValueAtTime(0, t + 0.3);
            osc.start(t); osc.stop(t + 0.3);
        } else if (type === 'break') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(50, t);
            gain.gain.setValueAtTime(0.2, t);
            gain.gain.exponentialRampToValueAtTime(0.01, t + 0.1);
            osc.start(t); osc.stop(t + 0.1);
        } else if (type === 'stomp') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(200, t);
            osc.frequency.linearRampToValueAtTime(50, t + 0.1);
            gain.gain.setValueAtTime(0.1, t);
            gain.gain.linearRampToValueAtTime(0, t + 0.1);
            osc.start(t); osc.stop(t + 0.1);
        } else if (type === 'music_intro') {
            // Ø¨Ø³ÙŠØ·Ø© Ø¬Ø¯Ø§Ù‹ Ø¹Ø´Ø§Ù† Ù…Ø§ ØªØ²Ø¹Ø¬
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(660, t);
            gain.gain.setValueAtTime(0.05, t);
            gain.gain.linearRampToValueAtTime(0, t + 0.5);
            osc.start(t); osc.stop(t + 0.5);
        }
    }
};

// === 2. Graphics (Pixel Art Generator) ===
const Palette = {
    _: null, // Transparent
    R: '#D70000', // Mario Red
    S: '#FFCC99', // Skin
    B: '#0000D3', // Blue/Black
    W: '#FFFFFF',
    O: '#E69C21', // Gold/Brick light
    K: '#884000', // Brick dark/Goomba
    G: '#00A800', // Pipe Green
    D: '#005000', // Pipe Dark
    Y: '#F8D820', // Question Block
    Z: '#000000'  // Outline
};

function createSprite(pattern) {
    const c = document.createElement('canvas');
    c.width = 16; c.height = 16;
    const cx = c.getContext('2d');
    for (let y = 0; y < 16; y++) {
        for (let x = 0; x < 16; x++) {
            const char = pattern[y][x];
            if (Palette[char]) {
                cx.fillStyle = Palette[char];
                cx.fillRect(x, y, 1, 1);
            }
        }
    }
    return c;
}

// Ø±Ø³ÙˆÙ…Ø§Øª 16x16 Ø¯Ù‚ÙŠÙ‚Ø©
const GFX = {
    marioIdle: createSprite([
        "_____RRRRR______",
        "____RRRRRRRRR___",
        "____KKKSKKS_____",
        "___SKSKKKKSKK___",
        "___SKSKKKKSKK___",
        "___SSKKKKSSSS___",
        "_____SSSSSSS____",
        "____RRRBRRR_____",
        "___RRRRBRRRR____",
        "__RRRRBBBBRRR___",
        "__BBRBWWWBBRR___",
        "__BBBWWWWWBBB___",
        "__BBWWWWWWWBB___",
        "___BBB___BBB____",
        "__KKKK___KKKK___",
        "_KKKKK___KKKKK__"
    ]),
    marioRun: createSprite([ // Ø¥Ø·Ø§Ø± Ø§Ù„Ø­Ø±ÙƒØ©
        "_____RRRRR______",
        "____RRRRRRRRR___",
        "____KKKSKKS_____",
        "___SKSKKKKSKK___",
        "___SKSKKKKSKK___",
        "___SSKKKKSSSS___",
        "_____SSSSSSS____",
        "____RRRBRRR_____",
        "___RRRRBRRRR____",
        "__RRRRBBBBRRR___",
        "__BBRBWWWBBRR___",
        "__BBBWWWWWBBB___",
        "__BBWWWWWWWBB___",
        "__BBBBBBBBBB____",
        "__KKKK__________",
        "__KKKK__________"
    ]),
    brick: createSprite([
        "KKKKKKKKKKKKKKKK",
        "KOOOOKOOOOOOOOOK",
        "KOOOOKOOOOOOOOOK",
        "KKKKKKKKKKKKKKKK",
        "KOOOOOOOOKOKOOOK",
        "KOOOOOOOOKOKOOOK",
        "KKKKKKKKKKKKKKKK",
        "KOOOKOOOOOOOOOOK",
        "KOOOKOOOOOOOOOOK",
        "KKKKKKKKKKKKKKKK",
        "KOOOOKOOOOOOOOOK",
        "KOOOOKOOOOOOOOOK",
        "KKKKKKKKKKKKKKKK",
        "KOOOOOOOOKOKOOOK",
        "KOOOOOOOOKOKOOOK",
        "KKKKKKKKKKKKKKKK"
    ]),
    qblock: createSprite([ // Question Block
        "KKKKKKKKKKKKKKKK",
        "KOOOOOOOOOOOOOKZ",
        "KOYYYYYYYYYYYOKZ",
        "KOYKKKKKKKKKYOKZ",
        "KOYKYYOOOOYKYOKZ",
        "KOYKYYOOOOYKYOKZ",
        "KOYKYYYYYKYKYOKZ",
        "KOYKYYYYKKYKYOKZ",
        "KOYKKKKKYYYKYOKZ",
        "KOYYYYYYYKYKYOKZ",
        "KOYYYYYYYKYKYOKZ",
        "KOYYYYYYYYYYYOKZ",
        "KOYYYYYYYKYKYOKZ",
        "KOYYYYYYYKYKYOKZ",
        "KOYYYYYYYYYYYOKZ",
        "KZZZZZZZZZZZZZZZ"
    ]),
    ground: createSprite([
        "KKKKKKKKKKKKKKKK",
        "KKOOOOOOOOOOOOKK",
        "KOOOOOOOOOOOOOOK",
        "KOOKKKKKKKKKKOOK",
        "KOKKKOOOOOOKKKOK",
        "KOKKOOOOOOOOKKOK",
        "KOKKOOOOOOOOKKOK",
        "KOKKOOOOOOOOKKOK",
        "KOKKKOOOOOOKKKOK",
        "KOOKKKKKKKKKKOOK",
        "KOOOOOOOOOOOOOOK",
        "KKOOOOOOOOOOOOKK",
        "KKKKKKKKKKKKKKKK",
        "KKKKKKKKKKKKKKKK",
        "KKKKKKKKKKKKKKKK",
        "KKKKKKKKKKKKKKKK"
    ]),
    pipe: createSprite([ // Left part of pipe
        "ZZZZZZZZZZZZZZZZ",
        "ZGGGGGGGGGGGGGDD",
        "ZGGDGGGGGGGGGDDD",
        "ZGGDGGGGGGGGGDDD",
        "ZGGDGGGGGGGGGDDD",
        "ZGGDGGGGGGGGGDDD",
        "ZGGDGGGGGGGGGDDD",
        "ZGGGGGGGGGGGGGDD",
        "ZZZZZZZZZZZZZZZZ",
        "ZZDGGGGGGGGGGDDZ",
        "ZZDGGGGGGGGGGDDZ",
        "ZZDGGGGGGGGGGDDZ",
        "ZZDGGGGGGGGGGDDZ",
        "ZZDGGGGGGGGGGDDZ",
        "ZZDGGGGGGGGGGDDZ",
        "ZZDGGGGGGGGGGDDZ"
    ]),
    goomba: createSprite([
        "_______ZZ_______",
        "______ZRRZ______",
        "_____ZRRRRZ_____",
        "____ZRRRRRRZ____",
        "___ZRRRRRRRRZ___",
        "___ZRRZRRZRRZ___",
        "__ZRRRWZZWRRZZ__",
        "__ZRRRZZZZRRRZ__",
        "__ZRRRRRRRRRRZ__",
        "___ZRRRRRRRRZ___",
        "____ZZZZZZZZ____",
        "____ZKKZZKKZ____",
        "___ZKKKZZKKKZ___",
        "___ZKKKZZKKKZ___",
        "___ZZZZ__ZZZZ___",
        "________________"
    ])
};

// === 3. Game Engine ===
const Game = {
    loop: null,
    level: 1,
    world: 1,
    score: 0,
    coins: 0,
    time: 400,
    state: 'MENU', // MENU, PLAYING, QUIZ
    cameraX: 0,
    safeX: 50, safeY: 100,
    
    entities: [],
    tiles: [],
    particles: [],

    init: function() {
        AudioSys.init();
        AudioSys.play('music_intro');
        document.getElementById('start-screen').classList.remove('active');
        this.startLevel(1);
        this.state = 'PLAYING';
        this.lastTime = performance.now();
        requestAnimationFrame(this.update.bind(this));
    },

    startLevel: function(lvlNum) {
        this.level = lvlNum;
        this.world = Math.ceil(lvlNum / 2); // World changes every 2 levels
        document.getElementById('world').innerText = this.world + '-' + ((lvlNum-1)%2 + 1);
        
        this.tiles = [];
        this.entities = [];
        this.particles = [];
        this.cameraX = 0;
        Player.reset();
        LevelBuilder.build(lvlNum);
    },

    update: function(time) {
        if (this.state === 'PLAYING') {
            const dt = (time - this.lastTime) / 1000;
            this.lastTime = time;

            Player.update(dt);
            
            // Camera follow
            let targetX = Player.x - WIDTH * 0.4;
            if (targetX < 0) targetX = 0;
            if (targetX > LevelBuilder.width - WIDTH) targetX = LevelBuilder.width - WIDTH;
            // Smooth cam
            this.cameraX += (targetX - this.cameraX) * 0.15;
            // Prevent going back too much
            if (Player.x < this.cameraX) Player.x = this.cameraX;

            // Entities
            this.entities.forEach(e => e.update(dt));
            this.particles.forEach(p => p.update(dt));
            // Cleanup
            this.particles = this.particles.filter(p => p.life > 0);

            // Time
            if (Math.floor(time/1000) % 1 === 0 && this.time > 0) {
               // Slow timer decrement
            }

            // HUD
            document.getElementById('score').innerText = this.score.toString().padStart(6, '0');
            document.getElementById('coins').innerText = 'x' + this.coins.toString().padStart(2, '0');
        }
        
        this.draw();
        if(this.state !== 'MENU') requestAnimationFrame(this.update.bind(this));
    },

    draw: function() {
        // Background color based on world
        ctx.fillStyle = (this.world % 2 === 0) ? '#000' : '#5C94FC'; // Cave or Sky
        ctx.fillRect(0, 0, WIDTH, HEIGHT);

        ctx.save();
        ctx.translate(-Math.floor(this.cameraX), 0);

        // Draw Tiles
        // Optimization: Render only visible tiles
        const startCol = Math.floor(this.cameraX / 16);
        const endCol = startCol + 17;
        
        this.tiles.forEach(t => {
            const col = t.x / 16;
            if (col >= startCol - 1 && col <= endCol + 1) {
                // Bounce animation for bricks
                let yOff = 0;
                if(t.bounce > 0) {
                    yOff = -Math.sin(t.bounce * Math.PI) * 8;
                    t.bounce -= 0.1;
                    if(t.bounce < 0) t.bounce = 0;
                }

                if (t.type === 'pipe') {
                    ctx.drawImage(GFX.pipe, t.x, t.y + yOff);
                    ctx.drawImage(GFX.pipe, t.x + 16, t.y + yOff); // Double width
                } else if(t.type === 'flag') {
                    ctx.fillStyle = '#fff'; ctx.fillRect(t.x+6, t.y, 4, 160);
                    ctx.fillStyle = '#00E700'; ctx.beginPath(); ctx.arc(t.x+8, t.y, 4, 0, 6.28); ctx.fill();
                    ctx.fillStyle = '#E70000'; ctx.fillRect(t.x+10, t.y+10, 20, 16);
                } else {
                    ctx.drawImage(GFX[t.type], t.x, t.y + yOff);
                }
            }
        });

        // Entities
        this.entities.forEach(e => {
            if (!e.dead && e.x > this.cameraX - 32 && e.x < this.cameraX + WIDTH + 32) {
                ctx.drawImage(GFX.goomba, e.x, e.y);
            }
        });

        // Player
        let sprite = GFX.marioIdle;
        if (!Player.grounded) sprite = GFX.marioRun; // Jump frame
        else if (Math.abs(Player.vx) > 0.5) {
            sprite = (Math.floor(Date.now() / 100) % 2 === 0) ? GFX.marioRun : GFX.marioIdle;
        }

        ctx.save();
        if (Player.facing === -1) {
            ctx.translate(Math.floor(Player.x) + 16, Math.floor(Player.y));
            ctx.scale(-1, 1);
            ctx.drawImage(sprite, 0, 0);
        } else {
            ctx.drawImage(sprite, Math.floor(Player.x), Math.floor(Player.y));
        }
        ctx.restore();

        // Particles
        this.particles.forEach(p => {
            ctx.fillStyle = p.c;
            ctx.fillRect(p.x, p.y, 4, 4);
        });

        ctx.restore();
    }
};

// === 4. Physics & Player ===
const Player = {
    x: 50, y: 100, w: 12, h: 16, // Width smaller than 16 for better feel
    vx: 0, vy: 0,
    speed: 130, jumpForce: 260, gravity: 900,
    grounded: false, facing: 1,
    
    reset: function() {
        this.x = 50; this.y = 100; this.vx = 0; this.vy = 0;
    },

    update: function(dt) {
        // Horizontal
        if (Input.right) { this.vx = this.speed; this.facing = 1; }
        else if (Input.left) { this.vx = -this.speed; this.facing = -1; }
        else { this.vx = 0; }

        this.x += this.vx * dt;
        this.checkCollisions(true);

        // Vertical
        if (Input.jump && this.grounded) {
            this.vy = -this.jumpForce;
            this.grounded = false;
            AudioSys.play('jump');
        }

        this.vy += this.gravity * dt;
        this.y += this.vy * dt;
        this.grounded = false;
        this.checkCollisions(false);

        // Level Bounds
        if (this.y > HEIGHT + 16) this.die();

        // Check Flag
        if (this.x > LevelBuilder.width - 32) {
            Game.score += 1000;
            Game.startLevel(Game.level + 1);
        }
        
        // Safety update
        if(this.grounded) {
            Game.safeX = this.x; Game.safeY = this.y - 16;
        }
    },

    checkCollisions: function(isX) {
        Game.tiles.forEach(t => {
            if (t.type === 'flag' || t.type === 'ground' && t.y > HEIGHT) return;
            // Simple AABB
            if (this.x < t.x + 16 && this.x + this.w > t.x &&
                this.y < t.y + 16 && this.y + this.h > t.y) {
                
                if (isX) {
                    if (this.vx > 0) this.x = t.x - this.w;
                    else if (this.vx < 0) this.x = t.x + 16;
                } else {
                    if (this.vy > 0) { // Landing
                        this.y = t.y - this.h;
                        this.vy = 0;
                        this.grounded = true;
                    } else if (this.vy < 0) { // Head bump
                        this.y = t.y + 16;
                        this.vy = 0;
                        this.hitBlock(t);
                    }
                }
            }
        });
        
        // Enemy collision
        Game.entities.forEach(e => {
            if(e.dead) return;
            if (this.x < e.x + 12 && this.x + this.w > e.x + 4 &&
                this.y < e.y + 12 && this.y + this.h > e.y) {
                
                if (this.vy > 0 && this.y + this.h < e.y + 10) {
                    // Stomp
                    e.dead = true;
                    this.vy = -150; // Bounce
                    Game.score += 200;
                    AudioSys.play('stomp');
                    e.y = HEIGHT + 100; // Move away
                } else {
                    this.die();
                }
            }
        });
    },

    hitBlock: function(t) {
        if(t.type === 'brick') {
            t.bounce = 1;
            AudioSys.play('break');
            // Spawn debris
            for(let i=0; i<4; i++) {
                Game.particles.push({x:t.x+8, y:t.y+8, vx:(Math.random()-0.5)*100, vy:-100-Math.random()*100, life:1, c:Palette.K});
            }
            // Remove brick visually (move far away) or change type
            t.type = 'empty'; // Invisible/Empty
            t.y = -1000;
        } else if (t.type === 'qblock') {
            t.bounce = 1;
            t.type = 'brick'; // Becomes solid brick
            Game.coins++;
            Game.score += 200;
            AudioSys.play('coin');
            // Spawn Coin effect
             Game.particles.push({x:t.x+8, y:t.y-16, vx:0, vy:-50, life:0.5, c:Palette.Y});
        }
    },

    die: function() {
        Game.state = 'QUIZ';
        document.getElementById('quiz-screen').classList.add('active');
        Quiz.generate();
    }
};

// === 5. Level Builder (8 Levels Logic) ===
const LevelBuilder = {
    width: 0,
    build: function(n) {
        // Procedural Generation based on "Seed" n
        // n determines difficulty: more holes, more enemies
        const len = 100 + n * 20; // Longer levels
        this.width = len * 16;
        const groundY = HEIGHT - 32;

        // Base Floor
        for (let i = 0; i < len; i++) {
            let isHole = false;
            if (i > 10 && i < len - 10) {
                // Random holes based on level number
                if (Math.random() < 0.05 + (n * 0.01)) isHole = true;
            }
            
            if (!isHole) {
                Game.tiles.push({ x: i * 16, y: groundY, type: 'ground' });
                Game.tiles.push({ x: i * 16, y: groundY + 16, type: 'ground' });
            }
        }

        // Features
        for (let i = 10; i < len - 10; i+= Math.floor(Math.random()*5)+3) {
            // Pipes
            if(Math.random() < 0.1) {
                const h = 32 + (Math.random() > 0.5 ? 16 : 0);
                Game.tiles.push({x: i*16, y: groundY-h, type:'pipe'});
                if(h > 32) Game.tiles.push({x: i*16, y: groundY-32, type:'pipe'});
                continue;
            }
            
            // Bricks & QBlocks
            const h = 48 + (Math.random() > 0.5 ? 32 : 0);
            if(Math.random() < 0.4) {
                const type = Math.random() < 0.3 ? 'qblock' : 'brick';
                Game.tiles.push({x:i*16, y:groundY-h, type:type, bounce:0});
                // Line of bricks
                if(Math.random() < 0.5) {
                    Game.tiles.push({x:(i+1)*16, y:groundY-h, type:'brick', bounce:0});
                    Game.tiles.push({x:(i+2)*16, y:groundY-h, type:'brick', bounce:0});
                }
            }
            
            // Enemies
            if(Math.random() < 0.1 + (n*0.05)) {
                Game.entities.push({x: i*16, y: groundY-16, w:16, h:16, vx:-20 - (n*5), vy:0, dead:false, update: function(dt){
                    if(this.dead) return;
                    this.x += this.vx * dt;
                    // Simple patrol logic
                    this.y += 100 * dt; // Gravity
                    // Collision with ground
                    Game.tiles.forEach(t=>{
                       if(this.x < t.x+16 && this.x+16 > t.x && this.y+16 > t.y && this.y < t.y+16) {
                           this.y = t.y - 16;
                       } 
                    });
                }});
            }
        }
        
        // Flag
        Game.tiles.push({x: (len-5)*16, y: groundY-128, type:'flag'});
    }
};

// === 6. Input & Quiz ===
const Input = { left: false, right: false, jump: false };
const Quiz = {
    timer: null,
    generate: function() {
        const isSum = Math.random() > 0.5;
        let a = Math.floor(Math.random()*6) + 1; // 1-6
        let b = Math.floor(Math.random()*5);     // 0-4
        if(!isSum && b > a) [a,b] = [b,a];
        
        const ans = isSum ? a+b : a-b;
        const op = isSum ? '+' : 'âˆ’';
        
        document.getElementById('math-q').innerText = `${toArabic(a)} ${op} ${toArabic(b)} = ØŸ`;
        
        // Visuals
        const v = document.getElementById('visual-math');
        v.innerHTML = '';
        // Draw A
        for(let i=0; i<a; i++) {
            let d = document.createElement('div'); d.className='dot';
            if(!isSum && i >= (a-b)) d.className += ' dead';
            v.appendChild(d);
        }
        // Draw B if sum
        if(isSum && b > 0) {
            let s = document.createElement('div'); s.className='op-sign'; s.innerText='+'; v.appendChild(s);
            for(let i=0; i<b; i++) {
                let d = document.createElement('div'); d.className='dot';
                v.appendChild(d);
            }
        }
        
        // Options
        const ag = document.getElementById('answers');
        ag.innerHTML = '';
        let opts = new Set([ans]);
        while(opts.size < 4) opts.add(Math.max(0, ans + Math.floor(Math.random()*5)-2));
        
        Array.from(opts).sort(()=>Math.random()-0.5).forEach(o => {
            let btn = document.createElement('button');
            btn.className = 'ans-btn';
            btn.innerText = toArabic(o);
            btn.onclick = () => this.check(o === ans, btn);
            ag.appendChild(btn);
        });
        
        // Timer
        let t = 30;
        const bar = document.getElementById('timer-bar');
        if(this.timer) clearInterval(this.timer);
        this.timer = setInterval(()=>{
            t--;
            bar.style.width = (t/30)*100 + '%';
            if(t<=0) location.reload();
        }, 1000);
    },
    
    check: function(isCorrect, btn) {
        if(isCorrect) {
            clearInterval(this.timer);
            document.getElementById('quiz-screen').classList.remove('active');
            Game.state = 'PLAYING';
            Player.x = Game.safeX; Player.y = Game.safeY - 30; Player.vx=0; Player.vy=0;
            Game.lastTime = performance.now();
        } else {
            btn.style.background = '#555';
        }
    }
};

function toArabic(n) { return (''+n).replace(/\d/g, d=>'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©'[d]); }

// Touch Events (Fixed)
function touch(id, key) {
    const el = document.getElementById(id);
    el.addEventListener('touchstart', e => { e.preventDefault(); Input[key]=true; });
    el.addEventListener('touchend', e => { e.preventDefault(); Input[key]=false; });
}
touch('btn-left', 'left');
touch('btn-right', 'right');
touch('btn-jump', 'jump');

// Keyboard
window.addEventListener('keydown', e => {
    if(e.code==='ArrowRight') Input.right=true;
    if(e.code==='ArrowLeft') Input.left=true;
    if(e.code==='Space'||e.code==='ArrowUp') Input.jump=true;
});
window.addEventListener('keyup', e => {
    if(e.code==='ArrowRight') Input.right=false;
    if(e.code==='ArrowLeft') Input.left=false;
    if(e.code==='Space'||e.code==='ArrowUp') Input.jump=false;
});

</script>
</body>
</html>
