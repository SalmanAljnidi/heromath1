<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Super Mario Logic - Stable</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        body { margin: 0; background: #000; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; touch-action: none; font-family: 'Press Start 2P', cursive; }
        
        #game-container {
            position: relative; width: 100%; max-width: 800px; aspect-ratio: 16/10;
            background: #5C94FC; border: 4px solid #fff; overflow: hidden;
        }
        
        canvas { display: block; width: 100%; height: 100%; image-rendering: pixelated; }
        
        #ui {
            position: absolute; top: 10px; left: 10px; right: 10px; display: flex; justify-content: space-between;
            color: #fff; text-shadow: 2px 2px #000; font-size: 14px; pointer-events: none; direction: ltr;
        }
        
        .screen {
            position: absolute; inset: 0; background: rgba(0,0,0,0.9); display: none;
            flex-direction: column; justify-content: center; align-items: center; z-index: 100; text-align: center; color: #fff;
        }
        .screen.active { display: flex; }
        
        button {
            margin-top: 20px; padding: 15px 30px; font-family: inherit; font-size: 16px;
            background: #e60012; color: #fff; border: 4px solid #fff; cursor: pointer;
        }
        button:active { transform: scale(0.95); }

        /* Quiz Styles */
        .quiz-box { background: #5C94FC; border: 4px solid #fff; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; }
        .timer-bar { height: 10px; background: #000; margin: 10px 0; }
        #timer-fill { height: 100%; background: #0f0; width: 100%; }
        .visuals { display: flex; justify-content: center; gap: 5px; flex-wrap: wrap; margin: 15px 0; }
        .ball { width: 20px; height: 20px; background: #f00; border: 2px solid #fff; border-radius: 50%; }
        .ball.cut { opacity: 0.3; text-decoration: line-through; }
        .answers { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .ans-btn { background: #fb0; border: 2px solid #000; color: #000; padding: 10px; }

        /* Controls */
        #controls { position: absolute; bottom: 20px; left: 20px; right: 20px; display: none; justify-content: space-between; pointer-events: none; }
        @media (hover: none) and (pointer: coarse) { #controls { display: flex; } }
        .dpad, .action { display: flex; gap: 20px; pointer-events: auto; }
        .btn-touch {
            width: 70px; height: 70px; background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.5);
            border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 24px; color: #fff;
        }
        .btn-touch:active { background: rgba(255,255,255,0.4); }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="canvas"></canvas>
    <div id="ui">
        <div>MARIO<br><span id="score">000000</span></div>
        <div>COINS<br><span id="coins">00</span></div>
        <div>WORLD<br><span>1-1</span></div>
    </div>

    <div id="start-screen" class="screen active">
        <h1 style="color:#fb0; text-shadow:4px 4px #d00;">SUPER HERO</h1>
        <p>Use Arrows/Space or Touch</p>
        <button onclick="Game.init()">START GAME</button>
    </div>

    <div id="quiz-screen" class="screen">
        <div class="quiz-box">
            <h2>MATH SAVE!</h2>
            <div class="timer-bar"><div id="timer-fill"></div></div>
            <div class="visuals" id="q-viz"></div>
            <h3 id="q-text" style="direction:ltr"></h3>
            <div class="answers" id="q-ans"></div>
        </div>
    </div>

    <div id="controls">
        <div class="dpad">
            <div class="btn-touch" id="btn-left">◀</div>
            <div class="btn-touch" id="btn-right">▶</div>
        </div>
        <div class="action">
            <div class="btn-touch" id="btn-jump">A</div>
        </div>
    </div>
</div>

<script>
// --- CORE ENGINE ---
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const W = 256;
const H = 240;
canvas.width = W; 
canvas.height = H;

// --- ASSETS (Base64 for reliability) ---
// Pixel Art Generators
const Colors = {r:'#D70000', s:'#FFCC99', b:'#0000D3', o:'#E79C21', k:'#943E00', l:'#D88820', g:'#00A800', y:'#FFD700'};
function drawSprite(p) {
    const c = document.createElement('canvas'); c.width=16; c.height=16; const x=c.getContext('2d');
    for(let i=0; i<16; i++) for(let j=0; j<16; j++) if(Colors[p[i][j]]) { x.fillStyle=Colors[p[i][j]]; x.fillRect(j,i,1,1); }
    return c;
}

const GFX = {
    mario: drawSprite(["_____rrrrr______","____rrrrrrrrr___","____kkkskks_____","___skskkkkskk___","___skskkkkskk___","___sskkkkssss___","_____sssssss____","____rrrbrrr_____","___rrrrbrrrr____","__rrrrbbbbrrr___","__bbrbwwwbbrr___","__bbbwwwwwbbb___","__bbwwwwwwwbb___","___bbb___bbb____","__kkkk___kkkk___","_kkkkk___kkkkk__"]),
    brick: drawSprite(["kkkkkkkkkkkkkkkk","kllllklllllllllko","kllllklllllllllko","kkkkkkkkkkkkkkkk","kllllllllklklllko","kllllllllklklllko","kkkkkkkkkkkkkkkk","klllkllllllllllko","klllkllllllllllko","kkkkkkkkkkkkkkkk","kllllklllllllllko","kllllklllllllllko","kkkkkkkkkkkkkkkk","kllllllllklklllko","kllllllllklklllko","kkkkkkkkkkkkkkkk"]),
    block: drawSprite(["kkkkkkkkkkkkkkkk","koooooooooooookz","koykkkkkkkkkyokz","koykyyooooykyokz","koykyyooooykyokz","koykyyyyykykyokz","koykyyyykkykyokz","koykkkkkyyykyokz","koyyyyyyykykyokz","koyyyyyyykykyokz","koyyyyyyyyyyyokz","koyyyyyyykykyokz","koyyyyyyykykyokz","koyyyyyyyyyyyokz","kzzzzzzzzzzzzzzz","kkkkkkkkkkkkkkkk"]),
    ground: drawSprite(["lkkkkkkkkkkkkkkl","kllllllllllllllk","kllllllllllllllk","kllllllllllllllk","kllkkkkkkkkkkllk","kllkllllllllkllk","kllkllllllllkllk","kllkllllllllkllk","kllkkkkkkkkkkllk","kllkllllllllkllk","kllkllllllllkllk","kllkllllllllkllk","kllkkkkkkkkkkllk","kllllllllllllllk","lkkkkkkkkkkkkkkl","llllllllllllllll"]),
    pipe: drawSprite(["gggggggggggggggg","gzzzzzzzzzzzzzzg","gzzggggggggggzzg","gzzggggggggggzzg","gzzggggggggggzzg","gzzggggggggggzzg","gzzggggggggggzzg","gzzzzzzzzzzzzzzg","gggggggggggggggg","gzzggggggggggzzg","gzzggggggggggzzg","gzzggggggggggzzg","gzzggggggggggzzg","gzzggggggggggzzg","gzzggggggggggzzg","gzzggggggggggzzg"]),
    goomba: drawSprite(["_______zz_______","______zrrz______","_____zrrrrz_____","____zrrrrrrz____","___zrrrrrrrrz___","___zrrzrrzrrz___","__zrrrwzzwrrzz__","__zrrrzzzzrrrz__","__zrrrrrrrrrrz__","___zrrrrrrrrz___","____zzzzzzzz____","____zkkzzkkz____","___zkkkzzkkkz___","___zkkkzzkkkz___","___zzzz__zzzz___","________________"])
};

// --- GAME STATE ---
const Game = {
    running: false,
    width: 0,
    tiles: [],
    enemies: [],
    camera: 0,
    score: 0,
    coins: 0,
    safeSpot: {x:50, y:100},
    
    init: function() {
        document.getElementById('start-screen').classList.remove('active');
        this.buildLevel();
        this.running = true;
        this.lastT = performance.now();
        Player.reset();
        requestAnimationFrame(loop);
    },

    // بناء يدوي للمرحلة (مضمون 100%)
    buildLevel: function() {
        this.tiles = [];
        this.enemies = [];
        const floorY = H - 32;
        
        // 1. الخريطة (رموز) - تصميم يدوي
        // . = فراغ, # = أرض, B = طوب, ? = صندوق, P = أنبوب, E = عدو, F = علم
        const map = 
        "..................................................................................................................................................." +
        "..................................................................................................................................................." +
        "..................................................................................................................................................." +
        "..................................................................................................................................................." +
        "..................................................................................................................................................." +
        "..................................................................................................................................................." +
        "..................................................................................................................................................." +
        "..................................................................................................................................................." +
        "..................................................................................................................................................." +
        "..............?.................B?B?B........................?..........B?B........................................................................" +
        "..................................................................................................................................................." +
        "..................................................................................................................................................." +
        ".........E.........P..........E.......P..........E....E......BBBBB.......................P.........................E.....................F........." +
        "########################..########################..########################..########################..########################..#################";

        // تحويل الخريطة لكائنات
        // الخريطة 14 سطر ارتفاع
        const rows = 14;
        const cols = map.length / rows;
        this.width = cols * 16;

        for(let r=0; r<rows; r++) {
            for(let c=0; c<cols; c++) {
                const char = map[r * cols + c];
                const x = c * 16;
                const y = r * 16 + (H - rows*16); // محاذاة للأسفل
                
                if(char === '#') {
                    this.tiles.push({x, y, t:'ground'});
                    this.tiles.push({x, y:y+16, t:'ground'}); // طبقة ثانية تحتها
                } else if(char === 'B') {
                    this.tiles.push({x, y, t:'brick', oy:y});
                } else if(char === '?') {
                    this.tiles.push({x, y, t:'block', oy:y});
                } else if(char === 'P') {
                    this.tiles.push({x, y, t:'pipe'});
                    this.tiles.push({x, y:y+16, t:'pipe'});
                } else if(char === 'F') {
                    for(let k=0; k<10; k++) this.tiles.push({x, y:y-(k*16), t:'flag'});
                } else if(char === 'E') {
                    this.enemies.push({x, y, w:16, h:16, vx:-40, vy:0, dead:false});
                }
            }
        }
    }
};

// --- PLAYER ---
const Player = {
    x: 50, y: 100, w: 12, h: 16,
    vx: 0, vy: 0,
    grounded: false,
    speed: 120, jump: 330, grav: 900,
    
    reset: function() { this.x=50; this.y=100; this.vx=0; this.vy=0; },
    
    update: function(dt) {
        // حركة
        if(Inputs.right) this.vx = this.speed;
        else if(Inputs.left) this.vx = -this.speed;
        else this.vx = 0;
        
        this.x += this.vx * dt;
        this.checkX();
        
        // قفز
        if(Inputs.jump && this.grounded) {
            this.vy = -this.jump;
            this.grounded = false;
        }
        
        this.vy += this.grav * dt;
        this.y += this.vy * dt;
        this.grounded = false;
        this.checkY();
        
        // حدود وموت
        if(this.y > H + 20) this.die();
        if(this.x < Game.camera) this.x = Game.camera;
        
        // كاميرا
        let target = this.x - W * 0.4;
        if(target < 0) target = 0;
        Game.camera += (target - Game.camera) * 0.1;
        
        // نقطة أمان
        if(this.grounded) {
            Game.safeSpot.x = this.x;
            Game.safeSpot.y = this.y - 20;
        }
    },
    
    checkX: function() {
        let p = {x:this.x, y:this.y, w:12, h:16};
        for(let t of Game.tiles) {
            if(t.t==='flag') continue;
            if(intersect(p, {x:t.x, y:t.y, w:16, h:16})) {
                if(this.vx > 0) this.x = t.x - 12;
                else if(this.vx < 0) this.x = t.x + 16;
                this.vx = 0;
            }
        }
    },
    
    checkY: function() {
        let p = {x:this.x, y:this.y, w:12, h:16};
        for(let t of Game.tiles) {
            if(t.t==='flag') continue;
            if(intersect(p, {x:t.x, y:t.y, w:16, h:16})) {
                if(this.vy > 0) { // هبوط
                    this.y = t.y - 16;
                    this.vy = 0;
                    this.grounded = true;
                } else if(this.vy < 0) { // رأس
                    this.y = t.y + 16;
                    this.vy = 0;
                    if(t.t==='block') { t.t='brick'; Game.coins++; Game.score+=100; t.bounce=5; }
                    if(t.t==='brick') { t.bounce=5; }
                }
            }
        }
    },
    
    die: function() {
        Game.running = false;
        Quiz.start();
    }
};

function intersect(r1, r2) {
    return r1.x < r2.x+r2.w && r1.x+r1.w > r2.x &&
           r1.y < r2.y+r2.h && r1.y+r1.h > r2.y;
}

// --- MAIN LOOP ---
function loop() {
    if(!Game.running) return;
    
    const now = performance.now();
    let dt = (now - Game.lastT) / 1000;
    if(dt > 0.05) dt = 0.05;
    Game.lastT = now;
    
    Player.update(dt);
    
    // الأعداء
    Game.enemies.forEach(e => {
        if(e.dead) return;
        if(Math.abs(e.x - Player.x) < W) {
            e.x += e.vx * dt;
            e.y += 500 * dt;
            
            // أرضية العدو
            let onG = false;
            for(let t of Game.tiles) {
                if(t.t!=='flag' && intersect(e, {x:t.x, y:t.y, w:16, h:16})) {
                    if(e.y+12 <= t.y) { e.y = t.y-16; onG=true; }
                    else { e.vx *= -1; }
                }
            }
            
            // تصادم
            if(intersect(Player, e)) {
                if(Player.vy > 0 && Player.y < e.y+8) {
                    e.dead = true;
                    Player.vy = -200;
                    Game.score += 200;
                    e.y = 1000;
                } else {
                    Player.die();
                }
            }
        }
    });
    
    draw();
    requestAnimationFrame(loop);
    
    // UI Update
    document.getElementById('score').innerText = Game.score.toString().padStart(6,'0');
    document.getElementById('coins').innerText = Game.coins.toString().padStart(2,'0');
}

function draw() {
    ctx.fillStyle = '#5C94FC';
    ctx.fillRect(0,0,W,H);
    ctx.save();
    ctx.translate(-Math.floor(Game.camera), 0);
    
    const start = Game.camera - 16;
    const end = Game.camera + W + 16;
    
    for(let t of Game.tiles) {
        if(t.x >= start && t.x <= end) {
            let y = t.y;
            if(t.bounce) { y-=t.bounce; t.bounce--; if(t.bounce<0) t.bounce=0; }
            
            let img = GFX.ground;
            if(t.t==='brick') img=GFX.brick;
            if(t.t==='block') img=GFX.block;
            if(t.t==='pipe') { 
                ctx.fillStyle='#00aa00'; ctx.fillRect(t.x,t.y,16,16); 
                ctx.strokeStyle='#004400'; ctx.strokeRect(t.x,t.y,16,16); continue; 
            }
            if(t.t==='flag') {
                ctx.fillStyle='#fff'; ctx.fillRect(t.x+6,t.y,4,16); continue;
            }
            ctx.drawImage(img, t.x, y);
        }
    }
    
    for(let e of Game.enemies) {
        if(!e.dead && e.x>=start && e.x<=end) ctx.drawImage(GFX.goomba, e.x, e.y);
    }
    
    // Player
    ctx.save();
    if(Player.vx < 0) {
        ctx.translate(Math.floor(Player.x)+16, Math.floor(Player.y));
        ctx.scale(-1, 1);
        ctx.drawImage(GFX.mario, -4, 0);
    } else {
        ctx.drawImage(GFX.mario, Math.floor(Player.x), Math.floor(Player.y));
    }
    ctx.restore();
    
    ctx.restore();
}

// --- QUIZ & INPUT ---
const Inputs = { left:false, right:false, jump:false };
const Quiz = {
    timer: null,
    start: function() {
        document.getElementById('quiz-screen').classList.add('active');
        let a = Math.floor(Math.random()*6);
        let b = Math.floor(Math.random()*5);
        let isAdd = Math.random()>0.5;
        let ans = isAdd ? a+b : Math.abs(a-b);
        let op = isAdd ? '+' : '-';
        if(!isAdd && b>a) [a,b] = [b,a]; // swap
        
        const ar = n => (''+n).replace(/\d/g, d=>'٠١٢٣٤٥٦٧٨٩'[d]);
        document.getElementById('q-text').innerText = `${ar(a)} ${op} ${ar(b)} = ؟`;
        
        const v = document.getElementById('q-viz');
        v.innerHTML = '';
        for(let i=0; i<a; i++) {
            let d = document.createElement('div'); d.className='ball';
            if(!isAdd && i>=(a-b)) d.classList.add('cut');
            v.appendChild(d);
        }
        
        const g = document.getElementById('q-ans');
        g.innerHTML = '';
        let opts = [ans];
        while(opts.length<4) { let r=Math.max(0, ans+Math.floor(Math.random()*5)-2); if(!opts.includes(r)) opts.push(r); }
        opts.sort(()=>Math.random()-0.5);
        
        opts.forEach(o => {
            let btn=document.createElement('button'); btn.className='ans-btn'; btn.innerText=ar(o);
            btn.onclick = () => {
                if(o===ans) {
                    clearInterval(this.timer);
                    document.getElementById('quiz-screen').classList.remove('active');
                    Player.x = Game.safeSpot.x;
                    Player.y = Game.safeSpot.y;
                    Player.vx=0; Player.vy=0;
                    Game.running = true;
                    Game.lastT = performance.now();
                    loop();
                } else btn.style.background='#555';
            };
            g.appendChild(btn);
        });
        
        let t = 30;
        if(this.timer) clearInterval(this.timer);
        this.timer = setInterval(()=>{
            t--;
            document.getElementById('timer-fill').style.width = (t/30)*100+'%';
            if(t<=0) location.reload();
        }, 1000);
    }
};

function bind(id, k) {
    const e = document.getElementById(id);
    e.addEventListener('touchstart', ev=>{ ev.preventDefault(); Inputs[k]=true; });
    e.addEventListener('touchend', ev=>{ ev.preventDefault(); Inputs[k]=false; });
    e.addEventListener('mousedown', ev=>{ ev.preventDefault(); Inputs[k]=true; });
    e.addEventListener('mouseup', ev=>{ ev.preventDefault(); Inputs[k]=false; });
}
bind('btn-left', 'left');
bind('btn-right', 'right');
bind('btn-jump', 'jump');

window.addEventListener('keydown', e=>{
    if(e.code==='ArrowRight') Inputs.right=true;
    if(e.code==='ArrowLeft') Inputs.left=true;
    if(e.code==='Space') Inputs.jump=true;
});
window.addEventListener('keyup', e=>{
    if(e.code==='ArrowRight') Inputs.right=false;
    if(e.code==='ArrowLeft') Inputs.left=false;
    if(e.code==='Space') Inputs.jump=false;
});
</script>
</body>
</html>
