<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>سوبر بطل المعرفة - V15</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@700&family=Press+Start+2P&display=swap');
        
        * { box-sizing: border-box; touch-action: none; user-select: none; -webkit-user-select: none; }
        
        body {
            margin: 0; background: #111; color: white;
            font-family: 'Cairo', sans-serif;
            height: 100vh; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            overflow: hidden;
        }

        #game-box {
            position: relative;
            width: 100%; max-width: 800px;
            aspect-ratio: 16/10;
            background: #5C94FC;
            border: 4px solid #fff;
            box-shadow: 0 0 40px rgba(0,0,0,0.8);
            overflow: hidden;
        }

        canvas { display: block; width: 100%; height: 100%; image-rendering: pixelated; }

        #ui-layer {
            position: absolute; top: 10px; left: 10px; right: 10px;
            display: flex; justify-content: space-between;
            font-family: 'Press Start 2P', monospace;
            font-size: 14px; text-shadow: 2px 2px 0 #000;
            pointer-events: none; z-index: 10; direction: ltr;
        }

        .overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.92);
            display: none; flex-direction: column; 
            align-items: center; justify-content: center; z-index: 100;
            text-align: center;
        }
        .overlay.active { display: flex; }
        
        h1 { color: #ffce00; text-shadow: 4px 4px 0 #d32f2f; font-size: 32px; margin-bottom: 20px; font-family: 'Cairo'; }
        
        .btn-play {
            background: #00b300; color: white; border: 3px solid white;
            padding: 15px 50px; font-size: 22px; cursor: pointer;
            font-family: 'Cairo'; font-weight: bold; border-radius: 50px;
            box-shadow: 0 6px 0 #006600; transition: 0.1s;
        }
        .btn-play:active { transform: translateY(4px); box-shadow: 0 2px 0 #006600; }

        .quiz-modal {
            background: #6b8cff; border: 4px solid white; padding: 20px;
            border-radius: 15px; width: 90%; max-width: 450px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }
        .timer-bar { width: 100%; height: 12px; background: #222; margin-bottom: 15px; border-radius: 6px; overflow: hidden; }
        #timer-val { width: 100%; height: 100%; background: #0f0; }
        
        .dots-area { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; margin: 15px 0; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px; }
        .dot { width: 24px; height: 24px; background: #f44; border-radius: 50%; border: 2px solid #fff; }
        .dot.x { background: #555; opacity: 0.5; position: relative; }
        .dot.x::after { content:'✖'; position: absolute; left:50%; top:50%; transform:translate(-50%,-50%); color: #fff; font-size: 16px; }
        
        .q-text { font-size: 32px; direction: ltr; margin: 15px 0; text-shadow: 2px 2px 0 #000; font-family: 'Press Start 2P'; }
        
        .ans-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .ans-btn { background: #fc0; border: 3px solid #000; padding: 12px; font-size: 24px; font-weight: bold; border-radius: 10px; font-family: 'Cairo'; cursor: pointer; }

        #controls {
            position: absolute; bottom: 20px; left: 20px; right: 20px;
            display: none; justify-content: space-between; z-index: 50;
            pointer-events: none;
        }
        @media (hover: none) and (pointer: coarse) { #controls { display: flex; } }
        
        .dpad { display: flex; gap: 20px; pointer-events: auto; }
        .action { pointer-events: auto; }
        
        .t-btn {
            width: 80px; height: 80px; 
            background: rgba(255,255,255,0.15);
            border: 3px solid rgba(255,255,255,0.6); 
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 36px; color: white;
            backdrop-filter: blur(4px);
        }
        .t-btn:active { background: rgba(255,255,255,0.4); transform: scale(0.95); }
        .btn-a { background: rgba(255, 60, 60, 0.3); border-color: rgba(255, 100, 100, 0.7); font-weight: 900; }

        .footer { margin-top: 15px; color: #777; font-size: 11px; }
    </style>
</head>
<body>

<div id="game-box">
    <canvas id="canvas"></canvas>
    
    <div id="ui-layer">
        <div>SCORE<br><span id="score">000000</span></div>
        <div>COINS<br><span id="coins">x00</span></div>
        <div>WORLD<br><span id="world">1-1</span></div>
    </div>

    <div id="start-screen" class="overlay active">
        <h1>سوبر بطل المعرفة</h1>
        <p>اجمع العملات وحل المسائل!</p>
        <button class="btn-play" id="btn-start-game">ابدأ اللعب ▶</button>
    </div>

    <div id="quiz-screen" class="overlay">
        <div class="quiz-modal">
            <h2>فرصة للنجاة!</h2>
            <div class="timer-bar"><div id="timer-val"></div></div>
            <div class="dots-area" id="visuals"></div>
            <div class="q-text" id="question"></div>
            <div class="ans-grid" id="answers"></div>
        </div>
    </div>

    <div id="controls">
        <div class="dpad">
            <div class="t-btn" id="btn-left">◀</div>
            <div class="t-btn" id="btn-right">▶</div>
        </div>
        <div class="action">
            <div class="t-btn btn-a" id="btn-jump">A</div>
        </div>
    </div>
</div>

<div class="footer">جميع الحقوق محفوظة لـ سلمان الجنيدي</div>

<script>
// === 1. المحرك ===
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const WIDTH = 256;
const HEIGHT = 240;
canvas.width = WIDTH;
canvas.height = HEIGHT;

let state = 'MENU';
let lastTime = 0;
let cameraX = 0;
let score = 0;
let coins = 0;
let inputs = { left:false, right:false, jump:false };
let audioCtx = null;
let safeSpot = {x: 50, y: 100}; // نقطة الأمان للحفظ

// === 2. الرسومات (ألوان ماريو الأصلية) ===
const Pal = {
    r:'#D00', s:'#FB8', b:'#00A', w:'#FFF', 
    o:'#E79C21', k:'#943E00', // K: بني غامق للأرضية
    l:'#D88820', // L: برتقالي للأرضية
    g:'#00A800', d:'#005000', y:'#FFD700', z:'#000'
};

function makeSprite(art) {
    const c = document.createElement('canvas');
    c.width=16; c.height=16;
    const x = c.getContext('2d');
    for(let i=0; i<16; i++) {
        if(!art[i]) continue;
        for(let j=0; j<16; j++) {
            const p = art[i][j];
            if(Pal[p]) { x.fillStyle=Pal[p]; x.fillRect(j,i,1,1); }
        }
    }
    return c;
}

const GFX = {
    mario: makeSprite([
        "_____rrrrr______","____rrrrrrrrr___","____kkkskks_____","___skskkkkskk___",
        "___skskkkkskk___","___sskkkkssss___","_____sssssss____","____rrrbrrr_____",
        "___rrrrbrrrr____","__rrrrbbbbrrr___","__bbrbwwwbbrr___","__bbbwwwwwbbb___",
        "__bbwwwwwwwbb___","___bbb___bbb____","__kkkk___kkkk___","_kkkkk___kkkkk__"
    ]),
    brick: makeSprite([
        "kkkkkkkkkkkkkkkk","kllllklllllllllko","kllllklllllllllko","kkkkkkkkkkkkkkkk",
        "kllllllllklklllko","kllllllllklklllko","kkkkkkkkkkkkkkkk","klllkllllllllllko",
        "klllkllllllllllko","kkkkkkkkkkkkkkkk","kllllklllllllllko","kllllklllllllllko",
        "kkkkkkkkkkkkkkkk","kllllllllklklllko","kllllllllklklllko","kkkkkkkkkkkkkkkk"
    ]),
    qblock: makeSprite([
        "kkkkkkkkkkkkkkkk","koooooooooooookz","koykkkkkkkkkyokz","koykyyooooykyokz",
        "koykyyooooykyokz","koykyyyyykykyokz","koykyyyykkykyokz","koykkkkkyyykyokz",
        "koyyyyyyykykyokz","koyyyyyyykykyokz","koyyyyyyyyyyyokz","koyyyyyyykykyokz",
        "koyyyyyyykykyokz","koyyyyyyyyyyyokz","kzzzzzzzzzzzzzzz","kkkkkkkkkkkkkkkk"
    ]),
    // أرضية ماريو الأصلية (بني غامق وفاتح)
    ground: makeSprite([
        "lkkkkkkkkkkkkkkl","kllllllllllllllk","kllllllllllllllk","kllllllllllllllk",
        "kllkkkkkkkkkkllk","kllkllllllllkllk","kllkllllllllkllk","kllkllllllllkllk",
        "kllkkkkkkkkkkllk","kllkllllllllkllk","kllkllllllllkllk","kllkllllllllkllk",
        "kllkkkkkkkkkkllk","kllllllllllllllk","lkkkkkkkkkkkkkkl","llllllllllllllll"
    ]),
    pipe: makeSprite([
        "gggggggggggggggg","gzzzzzzzzzzzzzzg","gzzggggggggggzzg","gzzggggggggggzzg",
        "gzzggggggggggzzg","gzzggggggggggzzg","gzzggggggggggzzg","gzzzzzzzzzzzzzzg",
        "gggggggggggggggg","gzzggggggggggzzg","gzzggggggggggzzg","gzzggggggggggzzg",
        "gzzggggggggggzzg","gzzggggggggggzzg","gzzggggggggggzzg","gzzggggggggggzzg"
    ]),
    goomba: makeSprite([
        "_______zz_______","______zrrz______","_____zrrrrz_____","____zrrrrrrz____",
        "___zrrrrrrrrz___","___zrrzrrzrrz___","__zrrrwzzwrrzz__","__zrrrzzzzrrrz__",
        "__zrrrrrrrrrrz__","___zrrrrrrrrz___","____zzzzzzzz____","____zkkzzkkz____",
        "___zkkkzzkkkz___","___zkkkzzkkkz___","___zzzz__zzzz___","________________"
    ])
};

// === 3. بناء المرحلة (الذكي) ===
let tiles = [];
let enemies = [];

function generateLevel(idx) {
    tiles = [];
    enemies = [];
    const groundY = HEIGHT - 32;
    const length = 220 + (idx * 50); 
    
    let isHoleSequence = 0; // لعد الفراغات المتتالية

    for(let i=0; i<length; i++) {
        let isHole = false;

        // شروط الحفر: ليس في البداية، ليس في النهاية، وليس بعد حفرة مباشرة (إلا إذا نبي حفرة عريضة)
        // لكن الأهم: التأكد من وجود "مهبط" بعد الحفرة
        if (i > 20 && i < length - 30) {
            // احتمال حفرة، بشرط أن الـ 3 بلوكات السابقة لم تكن حفرة (لتجنب الحفر المستحيلة)
            if (isHoleSequence === 0 && Math.random() < 0.1) {
                isHole = true;
                isHoleSequence = 2; // الحفرة عرضها بلوكتين دائماً
            } else if (isHoleSequence > 0) {
                isHole = true;
                isHoleSequence--;
            }
        }

        // بناء الأرضية
        if(!isHole) {
            tiles.push({x:i*16, y:groundY, t:'ground'});
            tiles.push({x:i*16, y:groundY+16, t:'ground'});
        } else {
            // إذا كان حفرة، نضمن أن الـ 4 بلوكات التالية أرضية مستوية خالية من العوائق
            // يتم التعامل معها في حلقة الكائنات بالأسفل
        }
    }
    
    // وضع الكائنات (طوب، أنابيب، أعداء)
    // نبدأ من 15 عشان نعطي مساحة للبدء
    for(let i=15; i<length-15; i++) {
        // تحقق: هل تحتنا أرضية؟
        let hasGround = tiles.some(t => t.x === i*16 && t.y === groundY);
        // تحقق: هل البلوكات السابقة كانت حفرة؟ (عشان ما نحط عائق فوراً بعد القفزة)
        let prevWasHole = !tiles.some(t => t.x === (i-1)*16 && t.y === groundY);
        let prevPrevWasHole = !tiles.some(t => t.x === (i-2)*16 && t.y === groundY);

        if (hasGround && !prevWasHole && !prevPrevWasHole) {
            
            // أنابيب (بشرط عدم وجود طوب فوقها)
            if (i % 25 === 0 && Math.random() < 0.8) {
                let h = (Math.random()>0.5)?32:48;
                for(let py=0; py<h; py+=16) {
                    tiles.push({x:i*16, y:groundY-py-16, t:'pipe'});
                }
                continue; // إذا حطينا أنبوب، ننتقل للي بعده
            }

            // طوب وصناديق
            if (i % 4 === 0 && Math.random() < 0.4) {
                let h = (Math.random() > 0.5) ? 48 : 80; 
                let type = (Math.random() > 0.3) ? 'brick' : 'qblock';
                tiles.push({x:i*16, y:groundY-h, t:type, oy:groundY-h});
                
                // عدو (فقط على الأرض وتحت الطوب أحياناً)
                if(Math.random() < 0.3) {
                    enemies.push({x:i*16, y:groundY-16, w:16, h:16, vx:-30, vy:0, dead:false});
                }
            }
        }
    }
    
    // علم النهاية
    tiles.push({x:(length-5)*16, y:groundY-16, t:'flag'});
    tiles.push({x:(length-5)*16, y:groundY-32, t:'flag'});
    tiles.push({x:(length-5)*16, y:groundY-48, t:'flag'});
    
    // إعادة تعيين اللاعب
    Player.x = 50; Player.y = 100; Player.vx=0; Player.vy=0;
    cameraX = 0;
    safeSpot = {x: 50, y: 100};
}

// === 4. كائن اللاعب ===
const Player = {
    x: 50, y: 100, w: 12, h: 16,
    vx: 0, vy: 0,
    speed: 130, jumpForce: 310, gravity: 900,
    grounded: false, dir: 1,
    
    update: function(dt) {
        if(inputs.right) { this.vx = this.speed; this.dir = 1; }
        else if(inputs.left) { this.vx = -this.speed; this.dir = -1; }
        else { this.vx = 0; }
        
        this.x += this.vx * dt;
        this.collide(true);
        
        if(inputs.jump && this.grounded) {
            this.vy = -this.jumpForce;
            this.grounded = false;
            playSound('jump');
        }
        
        this.vy += this.gravity * dt;
        this.y += this.vy * dt;
        this.grounded = false;
        this.collide(false);
        
        // تحديث نقطة الأمان عند الوقوف على الأرض
        if(this.grounded) {
            safeSpot.x = this.x;
            safeSpot.y = this.y - 20; // نخزن المكان فوق الأرض بشوي
        }

        // حدود
        if(this.y > HEIGHT + 50) die();
        if(this.x < cameraX) this.x = cameraX;
        
        // الكاميرا
        let targetCam = this.x - WIDTH * 0.4;
        if(targetCam < 0) targetCam = 0;
        cameraX += (targetCam - cameraX) * 0.1;
        
        // فوز
        let lastTile = tiles[tiles.length-1];
        if(lastTile && this.x > lastTile.x - 50) {
            score += 1000;
            generateLevel(1); 
        }
    },
    
    collide: function(isX) {
        let p = {x:this.x, y:this.y, w:12, h:16};
        for(let t of tiles) {
            if(t.t==='flag') continue;
            if(rectIntersect(p, {x:t.x, y:t.y, w:16, h:16})) {
                if(isX) {
                    if(this.vx > 0) this.x = t.x - 12;
                    else if(this.vx < 0) this.x = t.x + 16;
                } else {
                    if(this.vy > 0) { this.y = t.y - 16; this.vy = 0; this.grounded = true; }
                    else if(this.vy < 0) { 
                        this.y = t.y + 16; this.vy = 0;
                        if(t.t==='brick') { t.bounce=6; playSound('break'); }
                        if(t.t==='qblock') { t.t='brick'; t.bounce=6; coins++; score+=100; playSound('coin'); }
                    }
                }
            }
        }
    }
};

function rectIntersect(r1, r2) {
    return r1.x < r2.x + r2.w && r1.x + r1.w > r2.x &&
           r1.y < r2.y + r2.h && r1.y + r1.h > r2.y;
}

// === 5. المحرك الرئيسي ===
function startGame() {
    try {
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if(audioCtx.state === 'suspended') audioCtx.resume();
    } catch(e) {}
    
    document.getElementById('start-screen').classList.remove('active');
    generateLevel(0);
    state = 'PLAYING';
    lastTime = performance.now();
    loop();
}

function loop() {
    if(state !== 'PLAYING') return;
    const now = performance.now();
    const dt = Math.min((now - lastTime)/1000, 0.05);
    lastTime = now;
    
    Player.update(dt);
    
    // تحديث الأعداء
    enemies.forEach(e => {
        if(e.dead) return;
        if(Math.abs(e.x - Player.x) < WIDTH + 32) {
            e.x += e.vx * dt;
            e.y += 500 * dt;
            
            let onG = false;
            for(let t of tiles) {
                if(t.t==='flag') continue;
                if(rectIntersect(e, {x:t.x, y:t.y, w:16, h:16})) {
                    if(e.y + 12 <= t.y) { e.y = t.y - 16; onG = true; }
                    else { e.vx *= -1; }
                }
            }
            
            if(rectIntersect(Player, e)) {
                if(Player.vy > 0 && Player.y < e.y + 8) {
                    e.dead = true;
                    Player.vy = -200;
                    score += 200;
                    playSound('stomp');
                    e.y = 1000;
                } else {
                    die();
                }
            }
        }
    });
    
    draw();
    
    document.getElementById('ui-score').innerText = score.toString().padStart(6,'0');
    document.getElementById('ui-coins').innerText = 'x' + coins.toString().padStart(2,'0');
    
    requestAnimationFrame(loop);
}

function draw() {
    ctx.fillStyle = '#5C94FC';
    ctx.fillRect(0,0,WIDTH,HEIGHT);
    ctx.save();
    ctx.translate(-Math.floor(cameraX), 0);
    
    const start = cameraX - 16;
    const end = cameraX + WIDTH + 16;
    
    tiles.forEach(t => {
        if(t.x >= start && t.x <= end) {
            let y = t.y;
            if(t.bounce) { y -= t.bounce; t.bounce *= 0.8; if(t.bounce<0.5) t.bounce=0; }
            
            let img = GFX.ground;
            if(t.t==='brick') img=GFX.brick;
            else if(t.t==='qblock') img=GFX.qblock;
            else if(t.t==='pipe') { 
                ctx.fillStyle='#0A0'; ctx.fillRect(t.x,t.y,16,16); 
                ctx.strokeStyle='#050'; ctx.strokeRect(t.x,t.y,16,16); return; 
            }
            else if(t.t==='flag') {
                ctx.fillStyle='#fff'; ctx.fillRect(t.x+6,t.y,4,16); return;
            }
            ctx.drawImage(img, t.x, y);
        }
    });
    
    enemies.forEach(e => {
        if(!e.dead && e.x >= start && e.x <= end) ctx.drawImage(GFX.goomba, e.x, e.y);
    });
    
    ctx.save();
    if(Player.dir === -1) {
        ctx.translate(Math.floor(Player.x)+16, Math.floor(Player.y));
        ctx.scale(-1,1);
        ctx.drawImage(GFX.mario, -2, 0);
    } else {
        ctx.drawImage(GFX.mario, Math.floor(Player.x), Math.floor(Player.y));
    }
    ctx.restore();
    
    ctx.restore();
}

function die() {
    state = 'QUIZ';
    document.getElementById('quiz-screen').classList.add('active');
    Quiz.init();
}

// === 6. التحكم ===
document.getElementById('btn-start-game').addEventListener('click', startGame);

function bind(id, k) {
    const el = document.getElementById(id);
    el.addEventListener('touchstart', e=>{ e.preventDefault(); inputs[k]=true; });
    el.addEventListener('touchend', e=>{ e.preventDefault(); inputs[k]=false; });
    el.addEventListener('mousedown', e=>{ e.preventDefault(); inputs[k]=true; });
    el.addEventListener('mouseup', e=>{ e.preventDefault(); inputs[k]=false; });
}
bind('btn-left', 'left');
bind('btn-right', 'right');
bind('btn-jump', 'jump');

window.addEventListener('keydown', e => {
    if(e.code==='ArrowRight') inputs.right=true;
    if(e.code==='ArrowLeft') inputs.left=true;
    if(e.code==='Space'||e.code==='ArrowUp') inputs.jump=true;
});
window.addEventListener('keyup', e => {
    if(e.code==='ArrowRight') inputs.right=false;
    if(e.code==='ArrowLeft') inputs.left=false;
    if(e.code==='Space'||e.code==='ArrowUp') inputs.jump=false;
});

// === 7. الأسئلة والإنقاذ ===
const Quiz = {
    timer: null,
    init: function() {
        let a = Math.floor(Math.random()*5)+1;
        let b = Math.floor(Math.random()*5);
        let isAdd = Math.random()>0.5;
        if(!isAdd && b>a) [a,b]=[b,a];
        let ans = isAdd ? a+b : a-b;
        
        const map = ['٠','١','٢','٣','٤','٥','٦','٧','٨','٩'];
        const toAr = n => (''+n).replace(/\d/g, d=>map[d]);
        
        document.getElementById('question').innerText = `${toAr(a)} ${isAdd?'+':'-'} ${toAr(b)} = ؟`;
        
        const v = document.getElementById('visuals');
        v.innerHTML = '';
        for(let i=0; i<a; i++) {
            let d=document.createElement('div'); d.className='dot';
            if(!isAdd && i>=(a-b)) d.classList.add('x');
            v.appendChild(d);
        }
        
        const g = document.getElementById('answers');
        g.innerHTML = '';
        let opts = [ans];
        while(opts.length<4) { let r=Math.max(0, ans+Math.floor(Math.random()*5)-2); if(!opts.includes(r)) opts.push(r); }
        opts.sort(()=>Math.random()-0.5);
        
        opts.forEach(o => {
            let btn=document.createElement('button'); btn.className='ans-btn'; btn.innerText=toAr(o);
            btn.onclick = () => {
                if(o===ans) {
                    clearInterval(this.timer);
                    document.getElementById('quiz-screen').classList.remove('active');
                    state = 'PLAYING';
                    // استرجاع المكان الآمن
                    Player.x = safeSpot.x;
                    Player.y = safeSpot.y;
                    Player.vx = 0; Player.vy = 0;
                    lastTime = performance.now();
                    loop();
                } else btn.style.background='#555';
            };
            g.appendChild(btn);
        });
        
        let t=30;
        const bar=document.getElementById('timer-val');
        if(this.timer) clearInterval(this.timer);
        this.timer = setInterval(()=>{
            t--; bar.style.width = (t/30)*100 + '%';
            if(t<=0) location.reload();
        }, 1000);
    }
};

function playSound(type) {
    if(!audioCtx) return;
    try {
        const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        const t=audioCtx.currentTime;
        if(type==='jump'){ o.frequency.setValueAtTime(200,t); o.frequency.linearRampToValueAtTime(400,t+0.1); g.gain.setValueAtTime(0.1,t); o.start(t); o.stop(t+0.1); }
        if(type==='coin'){ o.frequency.setValueAtTime(900,t); g.gain.setValueAtTime(0.1,t); o.start(t); o.stop(t+0.1); }
        if(type==='break'){ o.type='sawtooth'; o.frequency.setValueAtTime(100,t); g.gain.setValueAtTime(0.1,t); o.start(t); o.stop(t+0.1); }
    } catch(e){}
}
</script>
</body>
</html>
