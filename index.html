<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>سوبر بطل المعرفة - العالم الكامل</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@700&family=Press+Start+2P&display=swap');
        
        body {
            margin: 0; background: #121212; color: white;
            font-family: 'Cairo', sans-serif;
            height: 100vh; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            overflow: hidden; touch-action: none; select: none;
        }

        #game-frame {
            position: relative;
            width: 100%; max-width: 800px;
            aspect-ratio: 16/10;
            background: #6b8cff; /* لون سماء ماريو الرسمي */
            border: 4px solid #fff;
            box-shadow: 0 0 40px rgba(0,0,0,0.6);
            overflow: hidden;
        }

        canvas { display: block; width: 100%; height: 100%; image-rendering: pixelated; }

        /* واجهة المعلومات */
        #hud {
            position: absolute; top: 12px; left: 12px; right: 12px;
            display: flex; justify-content: space-between;
            font-family: 'Press Start 2P', cursive;
            font-size: 14px; text-shadow: 2px 2px #000;
            pointer-events: none; z-index: 10; direction: ltr;
        }

        /* الشاشات */
        .overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.9);
            display: none; flex-direction: column; 
            align-items: center; justify-content: center; z-index: 100;
            text-align: center;
        }
        .overlay.active { display: flex; }
        
        h1 { color: #ffce00; text-shadow: 4px 4px #d32f2f; font-size: 32px; margin: 0 0 20px; font-family: 'Cairo'; }
        
        .btn {
            background: #00AA00; color: white; border: 3px solid white;
            padding: 15px 50px; font-size: 20px; cursor: pointer;
            font-family: 'Cairo'; font-weight: bold; border-radius: 50px;
            box-shadow: 0 5px 0 #006600; transition: 0.1s;
        }
        .btn:active { transform: translateY(4px); box-shadow: 0 2px 0 #006600; }

        /* نافذة السؤال */
        .quiz-panel {
            background: #6b8cff; border: 4px solid white; padding: 25px;
            border-radius: 15px; width: 90%; max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }
        .timer-bar { width: 100%; height: 10px; background: #333; margin-bottom: 20px; border-radius: 5px; overflow: hidden; }
        #timer-fill { width: 100%; height: 100%; background: #00E700; }
        
        .dots-area {
            display: flex; justify-content: center; gap: 8px; flex-wrap: wrap;
            margin: 20px 0; background: rgba(0,0,0,0.15); padding: 15px; border-radius: 10px;
        }
        .dot {
            width: 30px; height: 30px; background: #ff4444; border-radius: 50%;
            border: 3px solid white; box-shadow: 2px 2px 0 rgba(0,0,0,0.2);
        }
        .dot.crossed { background: #555; opacity: 0.6; position: relative; }
        .dot.crossed::after { content:'✖'; position: absolute; left:50%; top:50%; transform:translate(-50%,-50%); color: white; font-size: 20px; }
        
        .math-q { font-size: 40px; direction: ltr; margin: 20px 0; text-shadow: 3px 3px #000; font-family: 'Press Start 2P'; }
        
        .ans-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .ans-btn {
            background: #ffce00; border: 3px solid #000; padding: 15px;
            font-size: 28px; font-weight: bold; cursor: pointer; color: #000;
            border-radius: 10px; font-family: 'Cairo';
        }

        /* تحكم الجوال */
        #mobile-ctrl {
            position: absolute; bottom: 20px; left: 20px; right: 20px;
            display: none; justify-content: space-between; z-index: 50;
        }
        @media (hover: none) and (pointer: coarse) { #mobile-ctrl { display: flex; } }
        
        .dpad { display: flex; gap: 20px; }
        .t-btn {
            width: 80px; height: 80px; background: rgba(255,255,255,0.2);
            border: 4px solid rgba(255,255,255,0.7); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 40px; color: white; backdrop-filter: blur(5px);
            user-select: none; -webkit-tap-highlight-color: transparent;
        }
        .t-btn:active { background: rgba(255,255,255,0.5); transform: scale(0.95); }
        .btn-jump { background: rgba(255, 50, 50, 0.3); border-color: rgba(255, 100, 100, 0.8); }

        .footer { margin-top: 15px; color: #777; font-size: 12px; }
    </style>
</head>
<body>

<div id="game-frame">
    <canvas id="canvas"></canvas>
    
    <div id="hud">
        <div>MARIO<br><span id="score">000000</span></div>
        <div>COINS<br><span id="coins">x00</span></div>
        <div>WORLD<br><span id="world">1-1</span></div>
    </div>

    <div id="start-screen" class="overlay active">
        <h1>سوبر بطل المعرفة</h1>
        <p style="font-size: 16px; margin-bottom: 30px;">4 عوالم مختلفة • أسئلة ذكية • مغامرة شيقة</p>
        <button class="btn" onclick="Game.init()">ابدأ اللعب ▶</button>
    </div>

    <div id="quiz-screen" class="overlay">
        <div class="quiz-panel">
            <h2 style="color:#ffce00; margin:0; text-shadow:2px 2px #000;">فرصة للنجاة!</h2>
            <div style="font-size:14px; margin-bottom:10px;">أجب بسرعة لتكمل من نفس المكان</div>
            <div class="timer-bar"><div id="timer-fill"></div></div>
            <div class="dots-area" id="visual-area"></div>
            <div class="math-q" id="q-text"></div>
            <div class="ans-grid" id="ans-area"></div>
        </div>
    </div>

    <div id="mobile-ctrl">
        <div class="dpad">
            <div class="t-btn" id="btn-left">◀</div>
            <div class="t-btn" id="btn-right">▶</div>
        </div>
        <div class="t-btn btn-jump" id="btn-jump">A</div>
    </div>
</div>

<div class="footer">
    © برمجة وتطوير: <b>سلمان الجنيدي</b>
</div>

<script>
/**
 * Super Knowledge Hero - V7 Stable Gold Edition
 * Fixed freeze issues, added levels, enhanced colors.
 */

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
// NES Resolution
const WIDTH = 256;
const HEIGHT = 240;
canvas.width = WIDTH;
canvas.height = HEIGHT;

// === 1. Sound Engine (Safe Mode) ===
const AudioSys = {
    ctx: null,
    init: function() {
        if (!this.ctx) {
            this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (this.ctx.state === 'suspended') this.ctx.resume();
    },
    play: function(type) {
        if (!this.ctx) return;
        try {
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            osc.connect(gain);
            gain.connect(this.ctx.destination);
            const t = this.ctx.currentTime;

            if (type === 'jump') {
                osc.type = 'square';
                osc.frequency.setValueAtTime(150, t);
                osc.frequency.linearRampToValueAtTime(300, t + 0.1);
                gain.gain.setValueAtTime(0.1, t);
                gain.gain.linearRampToValueAtTime(0, t + 0.1);
                osc.start(t); osc.stop(t + 0.1);
            } else if (type === 'coin') {
                osc.type = 'sine';
                osc.frequency.setValueAtTime(988, t);
                osc.frequency.setValueAtTime(1319, t + 0.08);
                gain.gain.setValueAtTime(0.1, t);
                gain.gain.linearRampToValueAtTime(0, t + 0.3);
                osc.start(t); osc.stop(t + 0.3);
            } else if (type === 'break') {
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(100, t);
                gain.gain.setValueAtTime(0.1, t);
                gain.gain.exponentialRampToValueAtTime(0.01, t + 0.1);
                osc.start(t); osc.stop(t + 0.1);
            }
        } catch(e) { /* Ignore audio errors to prevent freeze */ }
    }
};

// === 2. Graphics Generator (Vibrant Palette) ===
const Colors = {
    _: null,
    R: '#FF3333', // Mario Red
    S: '#FFCC99', // Skin
    B: '#0066CC', // Mario Blue
    W: '#FFFFFF',
    O: '#FF9900', // Gold
    K: '#8B4513', // Brick Dark
    L: '#CD853F', // Brick Light
    G: '#00CC00', // Pipe Green
    D: '#006600', // Pipe Dark
    Y: '#FFD700', // Question
    Z: '#000000'
};

function genSprite(p) {
    const c = document.createElement('canvas');
    c.width = 16; c.height = 16;
    const x = c.getContext('2d');
    for(let i=0; i<16; i++) {
        for(let j=0; j<16; j++) {
            if(Colors[p[i][j]]) {
                x.fillStyle = Colors[p[i][j]];
                x.fillRect(j,i,1,1);
            }
        }
    }
    return c;
}

const GFX = {
    mario: genSprite([
        "_____RRRRR______",
        "____RRRRRRRRR___",
        "____KKKSKKS_____",
        "___SKSKKKKSKK___",
        "___SKSKKKKSKK___",
        "___SSKKKKSSSS___",
        "_____SSSSSSS____",
        "____RRRBRRR_____",
        "___RRRRBRRRR____",
        "__RRRRBBBBRRR___",
        "__BBRBWWWBBRR___",
        "__BBBWWWWWBBB___",
        "__BBWWWWWWWBB___",
        "___BBB___BBB____",
        "__KKKK___KKKK___",
        "_KKKKK___KKKKK__"
    ]),
    brick: genSprite([
        "KKKKKKKKKKKKKKKK",
        "KLLLLKLLLLLLLLLK",
        "KLLLLKLLLLLLLLLK",
        "KKKKKKKKKKKKKKKK",
        "KLLLLLLLLKLKLLLK",
        "KLLLLLLLLKLKLLLK",
        "KKKKKKKKKKKKKKKK",
        "KLLLKLLLLLLLLLLK",
        "KLLLKLLLLLLLLLLK",
        "KKKKKKKKKKKKKKKK",
        "KLLLLKLLLLLLLLLK",
        "KLLLLKLLLLLLLLLK",
        "KKKKKKKKKKKKKKKK",
        "KLLLLLLLLKLKLLLK",
        "KLLLLLLLLKLKLLLK",
        "KKKKKKKKKKKKKKKK"
    ]),
    qblock: genSprite([
        "KKKKKKKKKKKKKKKK",
        "KOOOOOOOOOOOOOKZ",
        "KOYKKKKKKKKKYOKZ",
        "KOYKYYOOOOYKYOKZ",
        "KOYKYYOOOOYKYOKZ",
        "KOYKYYYYYKYKYOKZ",
        "KOYKYYYYKKYKYOKZ",
        "KOYKKKKKYYYKYOKZ",
        "KOYYYYYYYKYKYOKZ",
        "KOYYYYYYYKYKYOKZ",
        "KOYYYYYYYYYYYOKZ",
        "KOYYYYYYYKYKYOKZ",
        "KOYYYYYYYKYKYOKZ",
        "KOYYYYYYYYYYYOKZ",
        "KZZZZZZZZZZZZZZZ"
    ]),
    ground: genSprite([
        "LLLLLLLLLLLLLLLL",
        "LKKKKKKKKKKKKKKL",
        "LKLLLLLLLLLLLLKL",
        "LKLLLLLLLLLLLLKL",
        "LKLKKKKKKKKKKLKL",
        "LKLKLLLLLLLLKLKL",
        "LKLKLLLLLLLLKLKL",
        "LKLKLLLLLLLLKLKL",
        "LKLKKKKKKKKKKLKL",
        "LKLLLLLLLLLLLLKL",
        "LKLLLLLLLLLLLLKL",
        "LKKKKKKKKKKKKKKL",
        "LLLLLLLLLLLLLLLL",
        "LLLLLLLLLLLLLLLL",
        "LLLLLLLLLLLLLLLL",
        "LLLLLLLLLLLLLLLL"
    ]),
    enemy: genSprite([
        "_______ZZ_______",
        "______ZRRZ______",
        "_____ZRRRRZ_____",
        "____ZRRRRRRZ____",
        "___ZRRRRRRRRZ___",
        "___ZRRZRRZRRZ___",
        "__ZRRRWZZWRRZZ__",
        "__ZRRRZZZZRRRZ__",
        "__ZRRRRRRRRRRZ__",
        "___ZRRRRRRRRZ___",
        "____ZZZZZZZZ____",
        "____ZKKZZKKZ____",
        "___ZKKKZZKKKZ___",
        "___ZKKKZZKKKZ___",
        "___ZZZZ__ZZZZ___",
        "________________"
    ])
};

// === 3. Designed Levels (Not Random) ===
// M: Ground, B: Brick, ?: QBlock, P: Pipe, E: Enemy, #: Gap
const LevelMaps = [
    // World 1-1: The Basics (Green Hill)
    "                                                                                                   F",
    "                                                                                                   F",
    "                ?                      B?B?B                     ?        B?B                      F",
    "                                                                                                   F",
    "         E              P          E             P           E   E       BBBBB                     F",
    "MMMMMMMMMMMMMMMMMMMMMMMMMMMM  MMMMMMMMMMMMMMMMMMMMMMMM  MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM",
    // World 1-2: Underground (More gaps)
    "                                                                                                   F",
    "         BBBBBB                  BB?BB?BB                  BBBBBB                                  F",
    "                    ?                                                                              F",
    "                                                 BBBB                                  BB          F",
    "    E           P          E   E       P                   E      E      P           BBBB          F",
    "MMMMMMMMMMMMMMMMMMMM  MMMMMMMMMMMMMMMMMMMMMMMM      MMMMMMMMMMMMMMMMMMMMMMMM  MMMMMMMMMMMMMMMMMMMMMM",
    // World 1-3: Sky Platforms
    "                                                                                                   F",
    "      ?        BBB           ?        BBB        ?        BBB           ?      BBB                 F",
    "         BBB          BBB        BBB        BBB       BBB        BBB                               F",
    "                                                                                      BB           F",
    "   E  BB           E  BB      E  BB      E  BB     E  BB      E  BB                 BBBB           F",
    "MMMM      MMMMMMMM      MMMM      MMMMMM      MMMM      MMMMMM      MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM",
    // World 1-4: Castle (Hard)
    "                                                                                                   F",
    "       ?   ?   ?          BBB?BBB           BBB?BBB          BBB?BBB                               F",
    "                                                                                                   F",
    "    P     P     P      P     P     P     P     P     P     P     P     P               BB          F",
    " E     E     E      E     E     E     E     E     E     E     E     E               BBBB          F",
    "MMMM  MMMM  MMMM   MMMM  MMMM  MMMM  MMMM  MMMM  MMMM  MMMM  MMMM  MMMM   MMMMMMMMMMMMMMMMMMMMMMMMMM"
];

// === 4. Game Engine ===
const Game = {
    loopId: null,
    levelIdx: 0,
    score: 0, coins: 0,
    cameraX: 0,
    state: 'MENU',
    
    // Objects
    tiles: [],
    enemies: [],
    
    startLevel: function(idx) {
        this.levelIdx = idx % LevelMaps.length;
        const map = LevelMaps[this.levelIdx];
        
        // Colors per world
        const bgColors = ['#6b8cff', '#000000', '#87CEEB', '#4a0d0d'];
        document.getElementById('game-frame').style.background = bgColors[idx % 4];
        document.getElementById('world').innerText = '1-' + (idx + 1);

        // Parse Map
        this.tiles = [];
        this.enemies = [];
        this.cameraX = 0;
        Player.reset();
        
        const groundY = HEIGHT - 32;
        
        for(let c=0; c<map.length; c++) {
            const char = map[c];
            const x = c * 16;
            
            // Floor
            if(char === 'M') {
                this.tiles.push({x:x, y:groundY, type:'ground'});
                this.tiles.push({x:x, y:groundY+16, type:'ground'});
            }
            // Objects
            else if(char === 'B') this.tiles.push({x:x, y:groundY-48, type:'brick', oy:groundY-48});
            else if(char === '?') this.tiles.push({x:x, y:groundY-48, type:'qblock', oy:groundY-48});
            else if(char === 'P') {
                this.tiles.push({x:x, y:groundY-16, type:'pipe'});
                this.tiles.push({x:x, y:groundY-32, type:'pipe'});
            }
            else if(char === 'F') {
                this.tiles.push({x:x, y:groundY-16, type:'flag'});
                this.tiles.push({x:x, y:groundY-32, type:'flag'});
                this.tiles.push({x:x, y:groundY-48, type:'flag'});
                this.tiles.push({x:x, y:groundY-64, type:'flag'});
            }
            // Enemies
            else if(char === 'E') {
                this.enemies.push({x:x, y:groundY-16, w:16, h:16, vx:-30, vy:0, dead:false});
            }
        }
    },

    init: function() {
        AudioSys.init();
        document.getElementById('start-screen').classList.remove('active');
        this.startLevel(0);
        this.state = 'PLAYING';
        this.lastTime = performance.now();
        this.update();
    },

    update: function() {
        if(this.state !== 'PLAYING') return;
        
        const now = performance.now();
        const dt = Math.min((now - this.lastTime)/1000, 0.05);
        this.lastTime = now;

        // Player
        Player.update(dt);
        
        // Camera
        let targetX = Player.x - WIDTH * 0.4;
        if(targetX < 0) targetX = 0;
        this.cameraX += (targetX - this.cameraX) * 0.1;
        if(Player.x < this.cameraX) Player.x = this.cameraX; // Wall

        // Enemies
        this.enemies.forEach(e => {
            if(e.dead) return;
            // Activate only when close
            if(Math.abs(e.x - Player.x) < WIDTH + 32) {
                e.x += e.vx * dt;
                e.y += 500 * dt; // Gravity
                
                // Ground Collision
                let onGround = false;
                this.tiles.forEach(t => {
                   if(rectCol(e, t)) {
                       if(e.y+e.h-4 <= t.y) { e.y = t.y - e.h; onGround = true; }
                       else { e.vx *= -1; } // Turn on wall
                   } 
                });
                
                // Player Collision
                if(rectCol(Player, e)) {
                    if(Player.vy > 0 && Player.y < e.y + 8) {
                        e.dead = true;
                        Player.vy = -200;
                        this.score += 200;
                        AudioSys.play('stomp');
                        e.y = 1000; // Remove
                    } else {
                        Player.die();
                    }
                }
            }
        });
        
        // HUD
        document.getElementById('score').innerText = this.score.toString().padStart(6,'0');
        document.getElementById('coins').innerText = 'x' + this.coins.toString().padStart(2,'0');

        this.draw();
        requestAnimationFrame(this.update.bind(this));
    },

    draw: function() {
        // Clear
        ctx.fillStyle = document.getElementById('game-frame').style.background;
        ctx.fillRect(0,0,WIDTH,HEIGHT);
        
        ctx.save();
        ctx.translate(-Math.floor(this.cameraX), 0);
        
        // Draw Tiles
        // Cull off-screen tiles for performance
        const startX = this.cameraX - 16;
        const endX = this.cameraX + WIDTH + 16;
        
        this.tiles.forEach(t => {
            if(t.x >= startX && t.x <= endX) {
                // Bounce anim
                let y = t.y;
                if(t.bounce) {
                    y -= Math.sin(t.bounce * Math.PI) * 6;
                    t.bounce -= 0.15;
                    if(t.bounce <= 0) t.bounce = 0;
                }
                
                let img = GFX.ground;
                if(t.type === 'brick') img = GFX.brick;
                else if(t.type === 'qblock') img = GFX.qblock;
                else if(t.type === 'pipe') {
                    ctx.fillStyle='#00aa00'; ctx.fillRect(t.x,t.y,16,16);
                    ctx.strokeStyle='#004400'; ctx.strokeRect(t.x,t.y,16,16);
                    return;
                }
                else if(t.type === 'flag') {
                    ctx.fillStyle='#fff'; ctx.fillRect(t.x+6, t.y, 4, 16);
                    ctx.fillStyle='#00e700'; ctx.beginPath(); ctx.arc(t.x+8,t.y,4,0,6.28); ctx.fill();
                    return;
                }
                ctx.drawImage(img, t.x, y);
            }
        });
        
        // Enemies
        this.enemies.forEach(e => {
            if(!e.dead && e.x >= startX && e.x <= endX) {
                ctx.drawImage(GFX.enemy, e.x, e.y);
            }
        });
        
        // Player
        ctx.save();
        if(Player.dir === -1) {
            ctx.translate(Math.floor(Player.x)+16, Math.floor(Player.y));
            ctx.scale(-1,1);
            ctx.drawImage(GFX.mario, 0, 0);
        } else {
            ctx.drawImage(GFX.mario, Math.floor(Player.x), Math.floor(Player.y));
        }
        ctx.restore();
        
        ctx.restore();
    }
};

const Player = {
    x: 50, y: 100, w: 12, h: 16,
    vx: 0, vy: 0,
    speed: 140, jump: 310, grav: 900,
    grounded: false, dir: 1,
    
    reset: function() { this.x=50; this.y=100; this.vx=0; this.vy=0; },
    
    update: function(dt) {
        // Move
        if(Input.right) { this.vx = this.speed; this.dir = 1; }
        else if(Input.left) { this.vx = -this.speed; this.dir = -1; }
        else { this.vx = 0; }
        
        this.x += this.vx * dt;
        this.checkCol(true);
        
        // Jump
        if(Input.jump && this.grounded) {
            this.vy = -this.jump;
            this.grounded = false;
            AudioSys.play('jump');
        }
        
        this.vy += this.grav * dt;
        this.y += this.vy * dt;
        this.grounded = false;
        this.checkCol(false);
        
        // Death
        if(this.y > HEIGHT + 20) this.die();
        
        // Win
        if(this.x > Game.tiles[Game.tiles.length-1].x - 100) {
            Game.score += 500;
            Game.startLevel(Game.levelIdx + 1);
        }
    },
    
    checkCol: function(isX) {
        Game.tiles.forEach(t => {
            if(t.type === 'flag') return;
            if(rectCol(this, t)) {
                if(isX) {
                    if(this.vx > 0) this.x = t.x - this.w;
                    else if(this.vx < 0) this.x = t.x + 16;
                } else {
                    if(this.vy > 0) {
                        this.y = t.y - this.h;
                        this.vy = 0;
                        this.grounded = true;
                    } else if(this.vy < 0) {
                        this.y = t.y + 16;
                        this.vy = 0;
                        // Hit block
                        if(t.type === 'brick') {
                            t.bounce = 1;
                            AudioSys.play('break');
                        } else if(t.type === 'qblock') {
                            t.bounce = 1;
                            t.type = 'brick';
                            Game.coins++;
                            Game.score += 100;
                            AudioSys.play('coin');
                        }
                    }
                }
            }
        });
    },
    
    die: function() {
        Game.state = 'QUIZ';
        document.getElementById('quiz-screen').classList.add('active');
        Quiz.show();
    }
};

function rectCol(r1, r2) {
    return r1.x < r2.x + 16 && r1.x + r1.w > r2.x &&
           r1.y < r2.y + 16 && r1.y + r1.h > r2.y;
}

const Input = { left:false, right:false, jump:false };

// === 5. Quiz Logic ===
const Quiz = {
    timer: null,
    show: function() {
        const isSum = Math.random() > 0.5;
        let a = Math.floor(Math.random()*6)+1;
        let b = Math.floor(Math.random()*5);
        if(!isSum && b>a) [a,b]=[b,a];
        
        const ans = isSum ? a+b : a-b;
        const op = isSum ? '+' : '−';
        
        const toAr = n => (''+n).replace(/\d/g, d=>'٠١٢٣٤٥٦٧٨٩'[d]);
        document.getElementById('q-text').innerText = `${toAr(a)} ${op} ${toAr(b)} = ؟`;
        
        // Visual
        const v = document.getElementById('visual-area');
        v.innerHTML = '';
        for(let i=0; i<a; i++) {
            let d = document.createElement('div'); d.className='dot';
            if(!isSum && i >= (a-b)) d.className += ' crossed';
            v.appendChild(d);
        }
        
        // Options
        const g = document.getElementById('ans-area');
        g.innerHTML = '';
        let opts = new Set([ans]);
        while(opts.size < 4) opts.add(Math.max(0, ans + Math.floor(Math.random()*5)-2));
        
        Array.from(opts).sort(()=>Math.random()-0.5).forEach(o => {
            let b = document.createElement('button');
            b.className = 'ans-btn';
            b.innerText = toAr(o);
            b.onclick = () => {
                if(o === ans) {
                    clearInterval(this.timer);
                    document.getElementById('quiz-screen').classList.remove('active');
                    Game.state = 'PLAYING';
                    // Respawn safe
                    Player.y = 0; Player.vy = 0; 
                    Player.x = Math.max(0, Player.x - 50);
                    Game.lastTime = performance.now();
                    Game.update();
                } else {
                    b.style.background = '#555';
                }
            };
            g.appendChild(b);
        });
        
        // Timer
        let t = 30;
        const bar = document.getElementById('timer-fill');
        if(this.timer) clearInterval(this.timer);
        this.timer = setInterval(() => {
            t--;
            bar.style.width = (t/30)*100 + '%';
            if(t<=0) location.reload();
        }, 1000);
    }
};

// Input Handling
function bind(id, k) {
    const e = document.getElementById(id);
    e.addEventListener('touchstart', (ev)=>{ev.preventDefault(); Input[k]=true;});
    e.addEventListener('touchend', (ev)=>{ev.preventDefault(); Input[k]=false;});
    e.addEventListener('mousedown', (ev)=>{ev.preventDefault(); Input[k]=true;});
    e.addEventListener('mouseup', (ev)=>{ev.preventDefault(); Input[k]=false;});
}
bind('btn-left', 'left');
bind('btn-right', 'right');
bind('btn-jump', 'jump');

window.addEventListener('keydown', e => {
    if(e.code==='ArrowRight') Input.right=true;
    if(e.code==='ArrowLeft') Input.left=true;
    if(e.code==='Space'||e.code==='ArrowUp') Input.jump=true;
});
window.addEventListener('keyup', e => {
    if(e.code==='ArrowRight') Input.right=false;
    if(e.code==='ArrowLeft') Input.left=false;
    if(e.code==='Space'||e.code==='ArrowUp') Input.jump=false;
});
</script>
</body>
</html>
