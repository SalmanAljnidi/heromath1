<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø³ÙˆØ¨Ø± Ø¨Ø·Ù„ Ø§Ù„Ù…Ø¹Ø±ÙØ© - Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Press+Start+2P&display=swap');
        
        body {
            margin: 0; background: #202020; color: white;
            font-family: 'Cairo', sans-serif;
            height: 100vh; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            overflow: hidden; touch-action: none;
        }

        #game-wrapper {
            position: relative;
            width: 100%; max-width: 800px;
            aspect-ratio: 16/10;
            background: #5C94FC;
            border: 4px solid #fff;
            box-shadow: 0 0 40px rgba(0,0,0,0.8);
            overflow: hidden;
        }

        canvas { display: block; width: 100%; height: 100%; image-rendering: pixelated; }

        #hud {
            position: absolute; top: 10px; left: 10px; right: 10px;
            display: flex; justify-content: space-between;
            font-family: 'Press Start 2P', cursive;
            font-size: 12px; text-shadow: 2px 2px #000;
            pointer-events: none; direction: ltr; z-index: 10;
        }

        .overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.9);
            display: none; flex-direction: column; 
            align-items: center; justify-content: center; z-index: 100;
        }
        .overlay.active { display: flex; }
        
        h1 { color: #ffce00; text-shadow: 4px 4px #b22222; margin-bottom: 20px; font-size: 24px; text-align: center; }
        .btn-start {
            background: #e70000; color: white; border: 4px solid white;
            padding: 15px 40px; font-size: 18px; cursor: pointer;
            font-family: 'Press Start 2P', cursive;
        }
        
        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¬ÙˆØ§Ù„ Ø§Ù„Ù…Ø­Ø³Ù†Ø© */
        #mobile-controls {
            position: absolute; bottom: 15px; left: 15px; right: 15px;
            display: none; justify-content: space-between; pointer-events: none; z-index: 50;
        }
        @media (hover: none) and (pointer: coarse) { #mobile-controls { display: flex; } }
        
        .ctrl-group { display: flex; gap: 20px; pointer-events: auto; }
        .t-btn {
            width: 80px; height: 80px; background: rgba(255,255,255,0.15);
            border: 4px solid rgba(255,255,255,0.5); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 30px; color: white; user-select: none;
            backdrop-filter: blur(4px);
        }
        .t-btn:active { background: rgba(255,255,255,0.4); transform: scale(0.95); }
        .btn-a { background: rgba(255, 0, 0, 0.2); border-color: rgba(255, 60, 60, 0.6); font-weight: bold; }

        /* Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© */
        .quiz-box {
            background: #5C94FC; border: 4px solid white; padding: 20px;
            border-radius: 10px; width: 90%; max-width: 400px;
            text-align: center; box-shadow: 10px 10px 0 #000;
        }
        .visual-math {
            display: flex; justify-content: center; gap: 6px; flex-wrap: wrap;
            margin: 15px 0; min-height: 40px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px;
        }
        .ball {
            width: 24px; height: 24px; background: radial-gradient(circle at 30% 30%, #ff4d4d, #990000);
            border-radius: 50%; border: 2px solid white; box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
        }
        .ball.crossed { opacity: 0.6; position: relative; background: #555; }
        .ball.crossed::after { content:'âœ–'; position: absolute; left:4px; top:0px; font-weight:bold; color:white; font-size: 16px; }
        
        .math-q { font-size: 30px; direction: ltr; margin-bottom: 20px; text-shadow: 2px 2px #000; font-family: 'Press Start 2P'; }
        
        .answers { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .ans-btn {
            background: #ffce00; border: 3px solid black; padding: 15px;
            font-size: 22px; font-weight: bold; cursor: pointer; color: black;
            font-family: 'Cairo'; border-radius: 8px;
        }
        
        .footer {
            margin-top: 10px; text-align: center; color: #888; font-size: 12px;
            display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;
        }
        .footer a { color: #ccc; text-decoration: none; display: flex; align-items: center; gap: 5px; }
        .footer img { width: 16px; height: 16px; }
    </style>
</head>
<body>

    <div id="game-wrapper">
        <canvas id="canvas"></canvas>
        
        <div id="hud">
            <div>MARIO<br><span id="score">000000</span></div>
            <div>COINS<br><span id="coins">x00</span></div>
            <div>WORLD<br><span>1-1</span></div>
            <div>TIME<br><span id="time">400</span></div>
        </div>

        <div id="start-screen" class="overlay active">
            <h1>Ø³ÙˆØ¨Ø± Ø¨Ø·Ù„ Ø§Ù„Ù…Ø¹Ø±ÙØ©</h1>
            <p style="margin-bottom:20px; font-size:14px; color:#ddd">Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø³Ù‡Ù… Ù„Ù„Ø­Ø±ÙƒØ© ÙˆØ§Ù„Ù‚ÙØ²</p>
            <button class="btn-start" onclick="startGame()">Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ù„Ø¨Ø¯Ø¡</button>
        </div>

        <div id="quiz-screen" class="overlay">
            <div class="quiz-box">
                <h2 style="margin:0 0 10px 0; color:#ffce00; text-shadow:2px 2px #000;">ÙØ±ØµØ© Ø£Ø®ÙŠØ±Ø©!</h2>
                <div style="width:100%; height:10px; background:#333; margin-bottom:10px;">
                    <div id="timer-bar" style="width:100%; height:100%; background:#0f0;"></div>
                </div>
                <div class="visual-math" id="visual-math"></div>
                <div class="math-q" id="math-q">5 + 3 = ?</div>
                <div class="answers" id="answers"></div>
            </div>
        </div>

        <div id="mobile-controls">
            <div class="ctrl-group">
                <div class="t-btn" id="btn-left">â—€</div>
                <div class="t-btn" id="btn-right">â–¶</div>
            </div>
            <div class="ctrl-group">
                <div class="t-btn btn-a" id="btn-jump">A</div>
            </div>
        </div>
    </div>

    <div class="footer">
        <span>Â© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù€ <b>Ø³Ù„Ù…Ø§Ù† Ø§Ù„Ø¬Ù†ÙŠØ¯ÙŠ</b></span>
        <a href="https://wa.me/966566996166" target="_blank">ğŸ“± ÙˆØ§ØªØ³Ø§Ø¨</a>
        <a href="https://snapchat.com/t/2tVDWcXq" target="_blank">ğŸ‘» Ø³Ù†Ø§Ø¨ Ø´Ø§Øª</a>
    </div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

// Ø¯Ù‚Ø© Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© (Ø±ÙŠØªØ±Ùˆ)
const W = 320;
const H = 240;
canvas.width = W;
canvas.height = H;

// === Ø§Ù„Ø±Ø³Ù… (Sprites) ===
function createBitmap(rows, palette) {
    const c = document.createElement('canvas');
    c.width = rows[0].length;
    c.height = rows.length;
    const cx = c.getContext('2d');
    for(let y=0; y<rows.length; y++) {
        for(let x=0; x<rows[y].length; x++) {
            const char = rows[y][x];
            if(palette[char]) {
                cx.fillStyle = palette[char];
                cx.fillRect(x,y,1,1);
            }
        }
    }
    return c;
}

const PALETTE = { 'R':'#f00', 'B':'#00f', 'S':'#fc9', 'W':'#fff', 'K':'#000', 'G':'#8B4513', 'L':'#CD853F', 'O':'#A0522D', 'Y':'#FFD700', 'Z':'#FF8C00' };

const SPRITES = {
    mario: {
        idle: createBitmap(["000RRRRR000","00RRRRRRRRR","00SSSKSSK00","0SKSSSSKS00","0SKSSSSKS00","0SSKKKKSS00","000SSSSS000","00RRBRR0000","0RRRBRRR000","RRRRBBBBRRR","KKRBWWWBKKK","KKKWWWWWKKK","KKWWWWWWKKK","00BBB0BBB00","0BBB00BBB00","BBB000BBB00"], PALETTE),
        run: createBitmap(["000RRRRR000","00RRRRRRRRR","00SSSKSSK00","0SKSSSSKS00","0SKSSSSKS00","0SSKKKKSS00","000SSSSS000","00RRBRR0000","0RRRBRRR000","RRRRBBBBRRR","KKRBWWWBKKK","KKKWWWWWKKK","KKWWWWWWKKK","00BBBBBB000","0BBBB000000","BBB00000000"], PALETTE),
        jump: createBitmap(["000RRRRR000","00RRRRRRRRR","00SSSKSSK00","0SKSSSSKS00","0SKSSSSKS00","0SSKKKKSS00","000SSSSS000","0RRRBRRR000","RRRRBBBBRRR","KKRBWWWBKKK","KKKWWWWWKKK","0BWWWWWWB00","0BBBBBBBB00","00000000000","00000000000","00000000000"], PALETTE)
    },
    goomba: createBitmap(["00000000000","000OOOO0000","00OOOOOO000","0OOOOOOOO00","0OOOOOOOO00","0OO0000OO00","0OO0WW0OO00","0OO0000OO00","0OOOOOOOO00","00OOOOOO000","00000000000","00KKK0KKK00","0KKKK0KKKK0","KKKKK0KKKKK","00000000000","00000000000"], PALETTE),
    brick: createBitmap(["BBBBBBBBBBBBBBBB","BZZZZBZZZZZZZZZB","BZZZZBZZZZZZZZZB","BBBBBBBBBBBBBBBB","BZZZZZZZZBZBZZZB","BZZZZZZZZBZBZZZB","BBBBBBBBBBBBBBBB","BZZZBZZZZZZZZZZB","BZZZBZZZZZZZZZZB","BBBBBBBBBBBBBBBB"], {'B':'#B22222', 'Z':'#CD5C5C'}),
    qblock: createBitmap(["YYYYYYYYYYYYYYYY","YZZZZZZZZZZZZZZK","YZKKKKKKKKKKKKZY","YZKYZZZZZZZZKYZY","YZKYZYYYYZZZKYZY","YZKYZYYYYZZZKYZY","YZKYZZZZZYYZKYZY","YZKYZZZZYYYZKYZY","YZKKKKKZYYZKKKZY","YZZZZZZZYYZZZZZY","YZZZZZZZYYZZZZZY","YZZZZZZZZZZZZZZK","YZZZZZZZYYZZZZZY","YZZZZZZZYYZZZZZY","YZZZZZZZZZZZZZZK","YKKKKKKKKKKKKKKK"], PALETTE),
    ground: createBitmap(["GGGGGGGGGGGGGGGG","GLLLLLLLLLLLLLLG","GLLLLLLLLLLLLLLG","GLLLLLLLLLLLLLLG","GLLLLLLLLLLLLLLG","GLLLOOOOOOOOLLLG","GLLOLLLLLLLLOLLG","GLLOLLLLLLLLOLLG","GLLOLLLLLLLLOLLG","GLLLOOOOOOOOLLLG","GLLLLLLLLLLLLLLG","GLLLLLLLLLLLLLLG","GLLLLLLLLLLLLLLG","GLLLLLLLLLLLLLLG","GGGGGGGGGGGGGGGG"], PALETTE)
};

// === 2. Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© ===
let state = 'MENU';
let cameraX = 0;
let score = 0;
let coins = 0;
let safeSpot = {x:50, y:0};

let player = { x: 50, y: 100, w: 12, h: 16, vx: 0, vy: 0, grounded: false, facing: 1, dead: false, frame: 0 };
let inputs = { left:false, right:false, jump:false };
let tiles = [];
let entities = [];

// === 3. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø±Ø­Ù„Ø© ===
function initLevel() {
    tiles = []; entities = [];
    const floorY = H - 32;
    
    // 1. Ø£Ø±Ø¶ÙŠØ© ØµÙ„Ø¨Ø© Ù…Ø³ØªÙ…Ø±Ø© Ù…Ø¹ Ø­ÙØ±
    for(let i=0; i<300; i++) {
        // Ø§Ù„Ø­ÙØ± ÙÙŠ Ø§Ù„Ø£Ù…Ø§ÙƒÙ†: 40, 75, 130
        if((i > 40 && i < 44) || (i > 75 && i < 80) || (i > 130 && i < 135)) continue;
        
        tiles.push({x: i*16, y: floorY, w:16, h:16, type:'ground'});
        tiles.push({x: i*16, y: floorY+16, w:16, h:16, type:'ground'});
    }

    // 2. Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
    const addObj = (x, y, type) => tiles.push({x: x*16, y: floorY - y*16, w:16, h:16, type: type});
    const addMob = (x) => entities.push({x: x*16, y: floorY - 16, w:16, h:16, type:'goomba', vx:-0.5, vy:0, dead:false});

    // Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ø±Ø­Ù„Ø©
    addObj(10, 4, 'qblock');
    addObj(14, 4, 'brick'); addObj(15, 4, 'qblock'); addObj(16, 4, 'brick');
    
    // Ø£Ù†Ø¨ÙˆØ¨
    tiles.push({x: 25*16, y: floorY-32, w:32, h:32, type:'pipe'});
    
    // Ø£Ø¹Ø¯Ø§Ø¡
    addMob(20); addMob(35);
    
    // Ù…Ù†Ø·Ù‚Ø© Ù…Ø±ØªÙØ¹Ø©
    addObj(45, 4, 'brick'); addObj(46, 4, 'brick'); addObj(47, 4, 'qblock'); addObj(48, 4, 'brick');
    addMob(47);
    
    // Ø£Ù†Ø¨ÙˆØ¨ÙŠÙ†
    tiles.push({x: 55*16, y: floorY-32, w:32, h:32, type:'pipe'});
    tiles.push({x: 65*16, y: floorY-48, w:32, h:48, type:'pipe'});
    addMob(60);

    // Ø¯Ø±Ø¬ Ù„Ù„Ù†Ù‡Ø§ÙŠØ©
    for(let i=0; i<8; i++) {
        for(let j=0; j<=i; j++) addObj(150+i, 1+j, 'brick');
    }
    
    // Ø¹Ù„Ù… Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
    tiles.push({x: 165*16, y: floorY-128, w:4, h:128, type:'flag'});
}

function startGame() {
    document.getElementById('start-screen').classList.remove('active');
    initLevel();
    player.x = 50; player.y = 100; player.vx = 0; player.vy = 0;
    cameraX = 0; score = 0; coins = 0;
    state = 'PLAYING';
    safeSpot = {x:50, y:100};
    loop();
}

// === 4. Ø­Ù„Ù‚Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© (Update Loop) ===
function loop() {
    if(state === 'PLAYING') {
        update();
        draw();
        requestAnimationFrame(loop);
    }
}

function update() {
    // Ø­Ø±ÙƒØ© Ø§Ù„Ù„Ø§Ø¹Ø¨
    if(inputs.right) { player.vx += 0.5; player.facing = 1; }
    else if(inputs.left) { player.vx -= 0.5; player.facing = -1; }
    else { player.vx *= 0.8; }
    
    // Ø³Ø±Ø¹Ø© Ù‚ØµÙˆÙ‰
    player.vx = Math.max(Math.min(player.vx, 2.5), -2.5);
    
    // Ø§Ù„Ù‚ÙØ²
    if(inputs.jump && player.grounded) {
        player.vy = -6.5;
        player.grounded = false;
    }
    
    player.vy += 0.3; // Ø§Ù„Ø¬Ø§Ø°Ø¨ÙŠØ©
    
    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø­Ø§ÙˆØ±
    player.x += player.vx;
    handleCollisions(true); // X Axis
    player.y += player.vy;
    player.grounded = false;
    handleCollisions(false); // Y Axis
    
    // Ø§Ù†ÙŠÙ…ÙŠØ´Ù†
    if(Math.abs(player.vx) > 0.1) player.frame += 0.2;
    
    // Ø­Ø¯ÙˆØ¯ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ (ÙŠÙ…Ù†Ø¹ Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø®Ù„Ù)
    if(player.x < cameraX) player.x = cameraX;
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ (ØªØªØ¨Ø¹ Ø§Ù„Ù„Ø§Ø¹Ø¨)
    if(player.x > cameraX + W*0.4) {
        cameraX = player.x - W*0.4;
    }
    
    // Ø§Ù„Ù…ÙˆØª Ø¨Ø§Ù„Ø³Ù‚ÙˆØ·
    if(player.y > H + 30) die();
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¡
    entities.forEach(e => {
        if(e.dead) return;
        if(Math.abs(e.x - player.x) < W) { // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¡ Ø§Ù„Ù‚Ø±ÙŠØ¨ÙŠÙ† ÙÙ‚Ø·
            e.vy += 0.3; e.x += e.vx; e.y += e.vy;
            // ØªØµØ§Ø¯Ù… Ø§Ù„Ø¹Ø¯Ùˆ Ù…Ø¹ Ø§Ù„Ø£Ø±Ø¶
            let eGrounded = false;
            tiles.forEach(t => {
                if(rectIntersect(e, t)) {
                    if(e.vy > 0 && e.y+e.h-4 <= t.y) { e.y = t.y - e.h; e.vy = 0; } // ÙˆÙ‚Ù
                    else if(t.type !== 'flag') { e.vx *= -1; } // ØµØ¯Ù… Ø¬Ø¯Ø§Ø±
                }
            });
            
            // ØªØµØ§Ø¯Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…Ø¹ Ø§Ù„Ø¹Ø¯Ùˆ
            if(rectIntersect(player, e)) {
                if(player.vy > 0 && player.y < e.y + 4) { // Ø¯Ø¹Ø³
                    e.dead = true;
                    player.vy = -3;
                    score += 100;
                } else {
                    die();
                }
            }
        }
    });

    // ØªØ­Ø¯ÙŠØ« Ù†Ù‚Ø·Ø© Ø§Ù„Ø£Ù…Ø§Ù†
    if(player.grounded) {
        safeSpot.x = player.x;
        safeSpot.y = player.y - 10;
    }
    
    // Ø§Ù„ÙÙˆØ²
    if(player.x > 165*16) {
        alert("Ù…Ø¨Ø±ÙˆÙƒ! Ø£Ù†Ù‡ÙŠØª Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!");
        document.getElementById('start-screen').classList.add('active');
        state = 'MENU';
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    document.getElementById('score').innerText = score.toString().padStart(6,'0');
    document.getElementById('coins').innerText = 'x' + coins.toString().padStart(2,'0');
}

function handleCollisions(isX) {
    tiles.forEach(t => {
        if(t.type === 'flag') return;
        if(rectIntersect(player, t)) {
            if(isX) {
                if(player.vx > 0) player.x = t.x - player.w;
                else if(player.vx < 0) player.x = t.x + t.w;
                player.vx = 0;
            } else {
                if(player.vy > 0) { // Ù‡Ø¨ÙˆØ·
                    player.y = t.y - player.h;
                    player.vy = 0;
                    player.grounded = true;
                } else if(player.vy < 0) { // Ù†Ø·Ø­
                    player.y = t.y + t.h;
                    player.vy = 0;
                    if(t.type === 'qblock') {
                        t.type = 'brick';
                        coins++; score+=50;
                    }
                }
            }
        }
    });
}

function rectIntersect(r1, r2) {
    return !(r2.x >= r1.x + r1.w || 
             r2.x + r2.w <= r1.x || 
             r2.y >= r1.y + r1.h ||
             r2.y + r2.h <= r1.y);
}

// === 5. Ø§Ù„Ø±Ø³Ù… ===
function draw() {
    // Ø§Ù„Ø³Ù…Ø§Ø¡
    ctx.fillStyle = '#5C94FC';
    ctx.fillRect(0, 0, W, H);
    
    ctx.save();
    ctx.translate(-Math.floor(cameraX), 0);
    
    // Ø§Ù„Ø¨Ù„Ø§Ø·
    tiles.forEach(t => {
        if(t.x + t.w < cameraX || t.x > cameraX + W) return; // ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ (Culling)
        
        if(t.type === 'pipe') {
            ctx.fillStyle = '#00AA00'; ctx.fillRect(t.x, t.y, t.w, t.h);
            ctx.strokeStyle = '#004400'; ctx.strokeRect(t.x, t.y, t.w, t.h);
            ctx.fillStyle = '#00D600'; ctx.fillRect(t.x+4, t.y, 4, t.h);
        } else if(t.type === 'flag') {
            ctx.fillStyle = '#fff'; ctx.fillRect(t.x, t.y, 4, 128);
            ctx.fillStyle = '#e00'; ctx.fillRect(t.x+4, t.y+10, 20, 16);
            ctx.fillStyle = '#ea0'; ctx.beginPath(); ctx.arc(t.x+2, t.y, 4, 0, 6.28); ctx.fill();
        } else {
            let img = SPRITES.ground;
            if(t.type === 'brick') img = SPRITES.brick;
            if(t.type === 'qblock') img = SPRITES.qblock;
            ctx.drawImage(img, t.x, t.y);
        }
    });
    
    // Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¡
    entities.forEach(e => {
        if(!e.dead && e.x > cameraX - 20 && e.x < cameraX + W + 20) {
            ctx.drawImage(SPRITES.goomba, e.x, e.y);
        }
    });
    
    // Ø§Ù„Ù„Ø§Ø¹Ø¨
    let pSprite = SPRITES.mario.idle;
    if(!player.grounded) pSprite = SPRITES.mario.jump;
    else if(Math.abs(player.vx) > 0.1) {
        pSprite = (Math.floor(player.frame) % 2 === 0) ? SPRITES.mario.run : SPRITES.mario.idle;
    }
    
    ctx.save();
    if(player.facing === -1) {
        ctx.translate(Math.floor(player.x) + 16, Math.floor(player.y));
        ctx.scale(-1, 1);
        ctx.drawImage(pSprite, 4, 0); // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø°Ø§Ø©
    } else {
        ctx.drawImage(pSprite, Math.floor(player.x), Math.floor(player.y));
    }
    ctx.restore();
    
    ctx.restore();
}

// === 6. Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ===
let timerInt;
function die() {
    state = 'QUIZ';
    document.getElementById('quiz-screen').classList.add('active');
    
    const isSum = Math.random() > 0.5;
    let a = Math.floor(Math.random()*11);
    let b = Math.floor(Math.random()*11);
    if(!isSum && b > a) [a,b] = [b,a];
    
    const ans = isSum ? a+b : a-b;
    const sign = isSum ? '+' : 'âˆ’';
    const toAr = n => (''+n).replace(/\d/g, d=>'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©'[d]);
    
    document.getElementById('math-q').innerText = `${toAr(a)} ${sign} ${toAr(b)} = ?`;
    
    // ÙƒØ±Ø§Øª
    const v = document.getElementById('visual-math');
    v.innerHTML = '';
    
    // Ø¹Ø¯Ø¯ Ø§Ù„ÙƒØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙƒØ¨ÙŠØ±)
    for(let i=0; i<a; i++) {
        let d = document.createElement('div');
        d.className = 'ball';
        if(!isSum && i >= (a-b)) d.classList.add('crossed');
        v.appendChild(d);
    }
    // ÙÙŠ Ø§Ù„Ø¬Ù…Ø¹ Ù†Ø¶ÙŠÙ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø«Ø§Ù†ÙŠ
    if(isSum && b > 0) {
        let p = document.createElement('div'); p.innerText='+'; p.style.alignSelf='center';
        v.appendChild(p);
        for(let i=0; i<b; i++) {
             let d = document.createElement('div'); d.className='ball';
             v.appendChild(d);
        }
    }
    
    // Ø®ÙŠØ§Ø±Ø§Øª
    const box = document.getElementById('answers');
    box.innerHTML = '';
    let opts = new Set([ans]);
    while(opts.size < 4) opts.add(Math.max(0, ans + Math.floor(Math.random()*5)-2));
    
    Array.from(opts).sort(()=>Math.random()-0.5).forEach(o => {
        let b = document.createElement('button');
        b.className = 'ans-btn';
        b.innerText = toAr(o);
        b.onclick = () => {
            if(o === ans) {
                clearInterval(timerInt);
                document.getElementById('quiz-screen').classList.remove('active');
                state = 'PLAYING';
                player.x = safeSpot.x;
                player.y = safeSpot.y;
                player.vx = 0; player.vy = 0;
                loop();
            } else {
                b.style.background = '#555';
            }
        };
        box.appendChild(b);
    });
    
    // Ù…Ø¤Ù‚Øª
    let t = 30;
    const bar = document.getElementById('timer-bar');
    if(timerInt) clearInterval(timerInt);
    timerInt = setInterval(() => {
        t--;
        bar.style.width = (t/30)*100 + '%';
        if(t<=0) {
            clearInterval(timerInt);
            location.reload(); // Ø®Ø³Ø§Ø±Ø© ÙƒØ§Ù…Ù„Ø©
        }
    }, 1000);
}

// === 7. Ø§Ù„ØªØ­ÙƒÙ… ===
// Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­
window.addEventListener('keydown', e => {
    if(e.code==='ArrowRight') inputs.right=true;
    if(e.code==='ArrowLeft') inputs.left=true;
    if(e.code==='Space'||e.code==='ArrowUp') inputs.jump=true;
});
window.addEventListener('keyup', e => {
    if(e.code==='ArrowRight') inputs.right=false;
    if(e.code==='ArrowLeft') inputs.left=false;
    if(e.code==='Space'||e.code==='ArrowUp') inputs.jump=false;
});

// Ù„Ù…Ø³ Ø§Ù„Ø¬ÙˆØ§Ù„ (Fixed)
function bindTouch(id, k) {
    const el = document.getElementById(id);
    el.addEventListener('touchstart', (e)=>{ e.preventDefault(); inputs[k]=true; });
    el.addEventListener('touchend', (e)=>{ e.preventDefault(); inputs[k]=false; });
}
bindTouch('btn-left', 'left');
bindTouch('btn-right', 'right');
bindTouch('btn-jump', 'jump');

</script>
</body>
</html>
